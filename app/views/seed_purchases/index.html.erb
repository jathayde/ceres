<%= render PageHeaderComponent.new(title: "Seed Purchases", subtitle: "Manage your seed inventory purchases") do |component| %>
  <% component.with_actions do %>
    <%= link_to "New Purchase", new_seed_purchase_path, class: "inline-flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors" %>
  <% end %>
<% end %>

<div data-controller="bulk-select" class="space-y-3">
  <div data-bulk-select-target="toolbar" class="hidden items-center gap-3 px-4 py-2 bg-amber-50 border border-amber-200 rounded-lg text-sm">
    <span><strong data-bulk-select-target="count">0</strong> selected</span>
    <button type="submit" form="bulk-mark-form"
      class="inline-flex items-center gap-1 px-3 py-1.5 bg-amber-600 text-white text-sm font-medium rounded-md hover:bg-amber-700 transition-colors"
      data-turbo-confirm="Mark selected purchases as used up?">Mark Selected as Used Up</button>
  </div>

  <%= form_with url: bulk_mark_used_up_seed_purchases_path, method: :patch, id: "bulk-mark-form", class: "hidden" do %><% end %>

  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left">
            <input type="checkbox" data-bulk-select-target="selectAll" data-action="change->bulk-select#toggleAll"
              class="rounded border-gray-300 text-green-600 focus:ring-green-500">
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plant</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Viability</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% @seed_purchases.each do |purchase| %>
          <tr class="hover:bg-gray-50 <%= 'opacity-50' if purchase.used_up? %>">
            <td class="px-4 py-4">
              <% unless purchase.used_up? %>
                <input type="checkbox" name="seed_purchase_ids[]" value="<%= purchase.id %>"
                  data-bulk-select-target="checkbox" data-action="change->bulk-select#updateCount"
                  form="bulk-mark-form"
                  class="rounded border-gray-300 text-green-600 focus:ring-green-500">
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm font-medium text-gray-900">
              <%= purchase.plant.name %>
              <div class="text-xs text-gray-500"><%= purchase.plant.plant_category.name %></div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500"><%= purchase.seed_source.name %></td>
            <td class="px-6 py-4 text-sm text-gray-500"><%= purchase.year_purchased %></td>
            <td class="px-6 py-4 text-sm"><%= render ViabilityBadgeComponent.new(status: purchase.viability_status) %></td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <% if purchase.seed_count.present? %>
                <%= purchase.seed_count %> seeds
              <% elsif purchase.weight_oz.present? %>
                <%= purchase.weight_oz %> oz
              <% end %>
              <% if purchase.packet_count.present? && purchase.packet_count > 1 %>
                (<%= purchase.packet_count %> pkts)
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <% if purchase.cost_cents.present? %>
                $<%= format("%.2f", purchase.cost_cents / 100.0) %>
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm">
              <div class="flex items-center justify-end gap-2">
                <% if purchase.used_up? %>
                  <%= button_to "Mark Active", mark_as_active_seed_purchase_path(purchase), method: :patch,
                    class: "text-green-600 hover:text-green-800" %>
                <% else %>
                  <%= button_to "Mark Used Up", mark_as_used_up_seed_purchase_path(purchase), method: :patch,
                    class: "text-amber-600 hover:text-amber-800" %>
                <% end %>
                <%= link_to "Edit", edit_seed_purchase_path(purchase), class: "text-green-600 hover:text-green-800" %>
                <%= button_to "Delete", seed_purchase_path(purchase), method: :delete,
                  class: "text-red-600 hover:text-red-800",
                  form: { data: { turbo_confirm: "Are you sure you want to delete this purchase?" } } %>
              </div>
            </td>
          </tr>
        <% end %>
        <% if @seed_purchases.empty? %>
          <tr>
            <td colspan="8" class="px-6 py-8 text-center text-sm text-gray-500">No seed purchases yet. Create one to get started.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
