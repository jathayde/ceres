<%= form_with(model: seed_purchase, class: "space-y-4", data: {
  controller: "inline-source",
  inline_source_url_value: seed_sources_inline_create_path
}) do |form| %>
  <% if seed_purchase.errors.any? %>
    <div class="rounded-md bg-red-50 p-4">
      <ul class="list-disc list-inside text-sm text-red-800">
        <% seed_purchase.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :plant_id, "Plant", class: "block text-sm font-medium text-gray-700" %>
    <%= form.select :plant_id,
      options_for_select(@plants.map { |p| ["#{p.name} (#{p.plant_category.name})", p.id] }, seed_purchase.plant_id),
      { include_blank: "Select a plant...", required: true },
      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
  </div>

  <fieldset>
    <legend class="text-sm font-semibold text-gray-900 mb-3">Source</legend>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <%= form.label :seed_source_id, "Seed Source", class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :seed_source_id,
          options_for_select(@seed_sources.map { |s| [s.name, s.id] }, seed_purchase.seed_source_id),
          { include_blank: "Select a source...", required: true },
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm",
          data: { inline_source_target: "sourceSelect" } %>
      </div>

      <div class="flex items-end">
        <button type="button" class="inline-flex items-center gap-1 px-3 py-2 text-sm font-medium text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition-colors"
          data-action="click->inline-source#toggleForm">
          + New Source
        </button>
      </div>
    </div>

    <div class="mt-3 p-4 bg-gray-50 rounded-md border border-gray-200 hidden" data-inline-source-target="formWrapper">
      <div class="space-y-3">
        <div>
          <label for="new_source_name" class="block text-sm font-medium text-gray-700">Source Name</label>
          <input type="text" id="new_source_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
            data-inline-source-target="nameInput">
        </div>
        <div>
          <label for="new_source_url" class="block text-sm font-medium text-gray-700">Website URL</label>
          <input type="url" id="new_source_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" placeholder="https://example.com"
            data-inline-source-target="urlInput">
        </div>
        <div class="flex items-center gap-2">
          <button type="button" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors"
            data-action="click->inline-source#createSource">
            Create Source
          </button>
          <button type="button" class="text-sm text-gray-500 hover:text-gray-700"
            data-action="click->inline-source#toggleForm">
            Cancel
          </button>
          <span class="text-sm text-red-600 hidden" data-inline-source-target="error"></span>
        </div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-sm font-semibold text-gray-900 mb-3">Purchase Details</legend>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <%= form.label :year_purchased, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :year_purchased, min: 1900, max: Date.current.year + 1,
          value: seed_purchase.year_purchased || Date.current.year,
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm", required: true %>
      </div>

      <div>
        <%= form.label :lot_number, class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :lot_number, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
      </div>

      <div>
        <%= form.label :germination_rate, "Germination Rate (%)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :germination_rate, min: 0, max: 100, step: 0.01,
          value: seed_purchase.germination_rate.present? ? (seed_purchase.germination_rate * 100).round(2) : nil,
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm",
          id: "germination_rate_display" %>
        <%= form.hidden_field :germination_rate, data: { inline_source_target: "germinationHidden" } %>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-sm font-semibold text-gray-900 mb-3">Quantity & Cost</legend>
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
      <div>
        <%= form.label :seed_count, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :seed_count, min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
      </div>

      <div>
        <%= form.label :weight_oz, "Weight (oz)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :weight_oz, min: 0, step: 0.01, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
      </div>

      <div>
        <%= form.label :packet_count, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :packet_count, min: 1, value: seed_purchase.packet_count || 1, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
      </div>

      <div>
        <%= form.label :cost_cents, "Cost ($)", class: "block text-sm font-medium text-gray-700" %>
        <input type="number" id="cost_display" min="0" step="0.01"
          value="<%= seed_purchase.cost_cents.present? ? format("%.2f", seed_purchase.cost_cents / 100.0) : '' %>"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
          data-inline-source-target="costDisplay">
        <%= form.hidden_field :cost_cents, data: { inline_source_target: "costHidden" } %>
      </div>
    </div>
  </fieldset>

  <div>
    <%= form.label :reorder_url, "Reorder URL", class: "block text-sm font-medium text-gray-700" %>
    <%= form.url_field :reorder_url, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm", placeholder: "https://example.com/product" %>
  </div>

  <div>
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700" %>
    <%= form.text_area :notes, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
  </div>

  <div class="flex items-center gap-3 pt-2">
    <%= form.submit class: "inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors cursor-pointer" %>
    <%= link_to "Cancel", seed_purchases_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
  </div>
<% end %>
