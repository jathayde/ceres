<%= form_with(model: buy_list_item, class: "space-y-4", data: {
  controller: "cascading-select",
  cascading_select_categories_url_value: categories_for_type_plants_path,
  cascading_select_subcategories_url_value: subcategories_for_category_plants_path,
  cascading_select_selected_category_value: buy_list_item.plant_category_id,
  cascading_select_selected_subcategory_value: buy_list_item.plant_subcategory_id
}) do |form| %>
  <% if buy_list_item.errors.any? %>
    <div class="rounded-md bg-red-50 p-4">
      <ul class="list-disc list-inside text-sm text-red-800">
        <% buy_list_item.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <p class="text-sm text-gray-600">Choose one level to add: a category, subcategory, or specific variety.</p>

  <fieldset>
    <legend class="text-sm font-semibold text-gray-900 mb-3">Target</legend>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <label for="plant_type_selector" class="block text-sm font-medium text-gray-700">Plant Type</label>
        <select id="plant_type_selector" name="plant_type_id"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
          data-cascading-select-target="plantType"
          data-action="change->cascading-select#typeChanged">
          <option value="">Select a type...</option>
          <% @plant_types.each do |pt| %>
            <option value="<%= pt.id %>" <%= "selected" if buy_list_item.plant_category&.plant_type_id == pt.id %>><%= pt.name %></option>
          <% end %>
        </select>
      </div>

      <div>
        <%= form.label :plant_category_id, "Category", class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :plant_category_id,
          options_for_select(@plant_categories.map { |c| [c.name, c.id] }, buy_list_item.plant_category_id),
          { include_blank: "Select a category..." },
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm",
          data: { cascading_select_target: "category", action: "change->cascading-select#categoryChanged" } %>
      </div>

      <div data-cascading-select-target="subcategoryWrapper" class="<%= 'hidden' if @plant_subcategories.empty? %>">
        <%= form.label :plant_subcategory_id, "Subcategory", class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :plant_subcategory_id,
          options_for_select(@plant_subcategories.map { |s| [s.name, s.id] }, buy_list_item.plant_subcategory_id),
          { include_blank: "None" },
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm",
          data: { cascading_select_target: "subcategory" } %>
      </div>
    </div>
  </fieldset>

  <div>
    <%= form.label :plant_id, "Specific Variety (optional)", class: "block text-sm font-medium text-gray-700" %>
    <p class="text-xs text-gray-500 mb-1">Leave blank to add at the category/subcategory level.</p>
    <%= form.select :plant_id,
      options_for_select(@plants.map { |p| ["#{p.name} (#{p.plant_category.name})", p.id] }, buy_list_item.plant_id),
      { include_blank: "Any variety in selected category" },
      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" %>
  </div>

  <div>
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700" %>
    <%= form.text_area :notes, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm", placeholder: "e.g., Saw this at Baker Creek, good reviews..." %>
  </div>

  <div class="flex items-center gap-3 pt-2">
    <%= form.submit class: "inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors cursor-pointer" %>
    <%= link_to "Cancel", buy_list_items_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
  </div>
<% end %>
