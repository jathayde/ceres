<%= render PageHeaderComponent.new(title: "Receive Items", subtitle: "Create seed purchases from your buy list") %>

<%= form_with url: fulfill_buy_list_items_path, method: :post, class: "space-y-6", data: {
  controller: "receive-form",
  receive_form_plants_url_value: plants_for_category_buy_list_items_path
} do |form| %>
  <div class="bg-white rounded-lg border border-gray-200 p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Shared Details</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" data-controller="inline-source" data-inline-source-url-value="<%= seed_sources_inline_create_path %>">
      <div>
        <label for="shared_seed_source_id" class="block text-sm font-medium text-gray-700">Seed Source</label>
        <select name="shared_seed_source_id" id="shared_seed_source_id" required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
          data-inline-source-target="sourceSelect">
          <option value="">Select a source...</option>
          <% @seed_sources.each do |source| %>
            <option value="<%= source.id %>"><%= source.name %></option>
          <% end %>
        </select>
        <div class="mt-2">
          <button type="button" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition-colors"
            data-action="click->inline-source#toggleForm">
            + New Source
          </button>
        </div>
        <div class="mt-3 p-4 bg-gray-50 rounded-md border border-gray-200 hidden" data-inline-source-target="formWrapper">
          <div class="space-y-3">
            <div>
              <label for="new_source_name" class="block text-sm font-medium text-gray-700">Source Name</label>
              <input type="text" id="new_source_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
                data-inline-source-target="nameInput">
            </div>
            <div>
              <label for="new_source_url" class="block text-sm font-medium text-gray-700">Website URL</label>
              <input type="url" id="new_source_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" placeholder="https://example.com"
                data-inline-source-target="urlInput">
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors"
                data-action="click->inline-source#createSource">
                Create Source
              </button>
              <button type="button" class="text-sm text-gray-500 hover:text-gray-700"
                data-action="click->inline-source#toggleForm">
                Cancel
              </button>
              <span class="text-sm text-red-600 hidden" data-inline-source-target="error"></span>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label for="shared_year_purchased" class="block text-sm font-medium text-gray-700">Year Purchased</label>
        <input type="number" name="shared_year_purchased" id="shared_year_purchased" required
          value="<%= Date.current.year %>" min="1900" max="<%= Date.current.year + 1 %>"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <h2 class="text-lg font-semibold text-gray-900">Items to Receive</h2>

    <% @buy_list_items.each_with_index do |item, index| %>
      <div class="bg-white rounded-lg border border-gray-200 p-6" data-receive-form-target="itemRow">
        <input type="hidden" name="items[<%= index %>][buy_list_item_id]" value="<%= item.id %>">

        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <h3 class="text-base font-medium text-gray-900"><%= item.target_name %></h3>
            <%= level_badge(item.target_level) %>
          </div>
          <label class="flex items-center gap-2 text-sm text-gray-500">
            <input type="checkbox" name="items[<%= index %>][skip]" value="1"
              class="rounded border-gray-300 text-gray-400 focus:ring-gray-500"
              data-action="change->receive-form#toggleSkip"
              data-receive-form-row-param="<%= index %>">
            Skip
          </label>
        </div>

        <div data-receive-form-target="itemFields" data-row-index="<%= index %>">
          <% if item.needs_variety_selection? %>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700">Variety</label>
              <% scope_key = item.plant_subcategory_id? ? [ :subcategory, item.plant_subcategory_id ] : [ :category, item.plant_category_id ] %>
              <select name="items[<%= index %>][plant_id]" required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
                <option value="">Select a variety...</option>
                <% (@plants_by_scope[scope_key] || []).each do |p| %>
                  <option value="<%= p.id %>"><%= p.name %></option>
                <% end %>
              </select>
            </div>
          <% else %>
            <input type="hidden" name="items[<%= index %>][plant_id]" value="<%= item.plant_id %>">
          <% end %>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Packets</label>
              <input type="number" name="items[<%= index %>][packet_count]" value="1" min="1"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Seed Count</label>
              <input type="number" name="items[<%= index %>][seed_count]" min="0"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Weight (oz)</label>
              <input type="number" name="items[<%= index %>][weight_oz]" min="0" step="0.01"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Cost ($)</label>
              <input type="number" min="0" step="0.01"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
                data-receive-form-target="costDisplay"
                data-action="input->receive-form#syncCost"
                data-receive-form-index-param="<%= index %>">
              <input type="hidden" name="items[<%= index %>][cost_cents]" data-receive-form-target="costHidden" data-row-index="<%= index %>">
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700">Notes</label>
            <input type="text" name="items[<%= index %>][notes]"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-sm"
              placeholder="Optional notes for this purchase">
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="flex items-center gap-3">
    <button type="submit" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors cursor-pointer">
      Receive Items
    </button>
    <%= link_to "Cancel", buy_list_items_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
  </div>
<% end %>
