<%= render PageHeaderComponent.new(title: "Buy List", subtitle: "Track seeds you want to purchase") do |component| %>
  <% component.with_actions do %>
    <%= link_to new_buy_list_item_path, class: "inline-flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      Add Item
    <% end %>
  <% end %>
<% end %>

<div class="flex flex-wrap items-center gap-2 mb-6">
  <% [["pending", "Pending (#{@pending_count})"], ["purchased", "Purchased (#{@purchased_count})"], ["all", "All"]].each do |value, label| %>
    <% is_active = @status_filter == value %>
    <%= link_to label,
          buy_list_items_path(status: value),
          class: "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium border transition-colors #{is_active ? 'bg-green-600 text-white border-green-600' : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'}" %>
  <% end %>
</div>

<div data-controller="bulk-select">
  <% if @status_filter == "pending" && @buy_list_items.any? %>
    <div data-bulk-select-target="toolbar" class="hidden items-center gap-3 px-4 py-2 mb-3 bg-green-50 border border-green-200 rounded-lg text-sm">
      <span><strong data-bulk-select-target="count">0</strong> selected</span>
      <button type="button" data-action="click->bulk-select#submitReceive" class="inline-flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors">
        Receive Selected
      </button>
    </div>
  <% end %>

  <form action="<%= receive_buy_list_items_path %>" method="get" class="hidden" data-bulk-select-target="receiveForm"></form>

  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <% if @status_filter == "pending" %>
            <th class="px-4 py-3 text-left">
              <input type="checkbox" data-bulk-select-target="selectAll" data-action="change->bulk-select#toggleAll"
                class="rounded border-gray-300 text-green-600 focus:ring-green-500">
            </th>
          <% end %>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
          <% if @status_filter != "pending" %>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <% end %>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% @buy_list_items.each do |item| %>
          <tr class="hover:bg-gray-50 <%= 'bg-green-50' if item.purchased? %>">
            <% if @status_filter == "pending" %>
              <td class="px-4 py-4">
                <input type="checkbox" name="buy_list_item_ids[]" value="<%= item.id %>"
                  data-bulk-select-target="checkbox" data-action="change->bulk-select#updateCount"
                  class="rounded border-gray-300 text-green-600 focus:ring-green-500">
              </td>
            <% end %>
            <td class="px-6 py-4 text-sm font-medium text-gray-900"><%= item.target_name %></td>
            <td class="px-6 py-4 text-sm"><%= level_badge(item.target_level) %></td>
            <td class="px-6 py-4 text-sm text-gray-500"><%= truncate(item.notes, length: 60) %></td>
            <% if @status_filter != "pending" %>
              <td class="px-6 py-4 text-sm">
                <% if item.purchased? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Purchased</span>
                <% else %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                <% end %>
              </td>
            <% end %>
            <td class="px-6 py-4 text-sm">
              <div class="flex items-center justify-end gap-2">
                <%= link_to "Edit", edit_buy_list_item_path(item), class: "text-green-600 hover:text-green-800 text-xs" %>
                <%= button_to "Remove", buy_list_item_path(item), method: :delete,
                  class: "text-red-600 hover:text-red-800 text-xs",
                  data: { turbo_confirm: "Remove this item from the buy list?" } %>
              </div>
            </td>
          </tr>
        <% end %>
        <% if @buy_list_items.empty? %>
          <tr>
            <td colspan="<%= @status_filter == 'pending' ? 5 : 5 %>" class="px-6 py-8 text-center text-sm text-gray-500">
              <% if @status_filter == "purchased" %>
                No purchased items yet.
              <% else %>
                Your buy list is empty. Browse the <%= link_to "inventory", root_path, class: "text-green-600 hover:text-green-800 underline" %> to add items.
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
