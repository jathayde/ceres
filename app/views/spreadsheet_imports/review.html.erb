<%= render PageHeaderComponent.new(title: "Review Import Mappings", subtitle: @import.original_filename) %>

<%= turbo_stream_from "spreadsheet_import_#{@import.id}" %>

<div id="import_status">
  <%= render "status", import: @import %>
</div>

<!-- Stats bar -->
<div class="mt-4 grid grid-cols-2 sm:grid-cols-5 gap-3">
  <div class="bg-white rounded-lg border border-gray-200 p-3 text-center">
    <div class="text-2xl font-bold text-gray-900"><%= @stats[:total] %></div>
    <div class="text-xs text-gray-500">Total Rows</div>
  </div>
  <div class="bg-white rounded-lg border border-indigo-200 p-3 text-center">
    <div class="text-2xl font-bold text-indigo-600"><%= @stats[:ai_mapped] %></div>
    <div class="text-xs text-gray-500">AI Mapped</div>
  </div>
  <div class="bg-white rounded-lg border border-green-200 p-3 text-center">
    <div class="text-2xl font-bold text-green-600"><%= @stats[:accepted] %></div>
    <div class="text-xs text-gray-500">Accepted</div>
  </div>
  <div class="bg-white rounded-lg border border-blue-200 p-3 text-center">
    <div class="text-2xl font-bold text-blue-600"><%= @stats[:modified] %></div>
    <div class="text-xs text-gray-500">Modified</div>
  </div>
  <div class="bg-white rounded-lg border border-amber-200 p-3 text-center">
    <div class="text-2xl font-bold text-amber-600"><%= @stats[:duplicates] %></div>
    <div class="text-xs text-gray-500">Duplicates</div>
  </div>
</div>

<% if @stats[:ai_mapped] > 0 %>
  <div class="mt-4 flex justify-end">
    <%= link_to bulk_accept_spreadsheet_import_path(@import),
          data: { turbo_method: :post, turbo_confirm: "Accept all #{@stats[:ai_mapped]} AI-mapped rows?" },
          class: "inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Accept All (<%= @stats[:ai_mapped] %>)
    <% end %>
  </div>
<% end %>

<!-- Taxonomy options (hidden, for Turbo Stream replacement) -->
<div id="taxonomy_options" class="hidden">
  <%= render "taxonomy_options", plant_types: @plant_types %>
</div>

<!-- Review table -->
<div class="mt-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Row</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variety</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">AI Mapping</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% @rows.each do |row| %>
          <%= render "review_row", row: row, plant_types: @plant_types, seed_sources: @seed_sources %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- New taxonomy modal -->
<div id="new_taxonomy_modal" class="hidden fixed inset-0 z-50 overflow-y-auto" data-controller="modal">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75" data-action="click->modal#close"></div>
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Taxonomy</h3>
      <%= form_with url: create_taxonomy_spreadsheet_import_path(@import), method: :post, data: { turbo_frame: "_top" } do |f| %>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Type</label>
            <select name="taxonomy_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm" data-action="change->modal#toggleFields">
              <option value="category">Category</option>
              <option value="subcategory">Subcategory</option>
            </select>
          </div>
          <div data-modal-target="categoryField">
            <label class="block text-sm font-medium text-gray-700">Plant Type</label>
            <select name="plant_type_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
              <% @plant_types.each do |pt| %>
                <option value="<%= pt.name %>"><%= pt.name %></option>
              <% end %>
            </select>
          </div>
          <div data-modal-target="subcategoryField" class="hidden">
            <label class="block text-sm font-medium text-gray-700">Category</label>
            <select name="category_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
              <% @plant_types.each do |pt| %>
                <% pt.plant_categories.each do |cat| %>
                  <option value="<%= cat.name %>"><%= pt.name %> &gt; <%= cat.name %></option>
                <% end %>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" data-action="click->modal#close" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
            Create
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>
