<%= render PageHeaderComponent.new(title: "Import: #{@import.original_filename}") %>

<% if @import.parsing? || @import.mapping? || @import.executing? %>
  <meta http-equiv="refresh" content="3">
<% end %>

<div id="import_status">
  <%= render "status", import: @import %>
</div>

<% if @import.parsed? || @import.parsing? %>
  <div class="mt-6 space-y-6">
    <% @rows_by_sheet.each do |sheet_name, rows| %>
      <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
          <h3 class="text-sm font-medium text-gray-900">
            <%= sheet_name %>
            <span class="ml-2 text-xs text-gray-500">(<%= rows.size %> rows)</span>
          </h3>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Row</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variety</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Germ %</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% rows.each do |row| %>
                <tr class="<%= row.has_gray_text? ? 'bg-gray-50 text-gray-400' : '' %>">
                  <td class="px-3 py-2 text-sm whitespace-nowrap"><%= row.row_number %></td>
                  <td class="px-3 py-2 text-sm"><%= row.variety_name || '—' %></td>
                  <td class="px-3 py-2 text-sm"><%= row.seed_source_name || '—' %></td>
                  <td class="px-3 py-2 text-sm whitespace-nowrap">
                    <% if row.year_purchased %>
                      <%= row.year_purchased %>
                    <% elsif row.raw_date_value.present? %>
                      <span class="text-amber-600" title="Raw: <%= row.raw_date_value %>">?</span>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td class="px-3 py-2 text-sm whitespace-nowrap"><%= row.quantity if row.quantity && row.quantity > 1 %></td>
                  <td class="px-3 py-2 text-sm whitespace-nowrap">
                    <% if row.germination_rate %>
                      <%= (row.germination_rate * 100).round(1) %>%
                    <% elsif row.raw_germination_value.present? %>
                      <span class="text-amber-600" title="Raw: <%= row.raw_germination_value %>">?</span>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td class="px-3 py-2 text-sm max-w-xs truncate"><%= row.notes || '—' %></td>
                  <td class="px-3 py-2 text-sm whitespace-nowrap">
                    <% if row.detected_used_up? %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Used Up</span>
                    <% end %>
                    <% if row.parse_warnings.any? %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800"
                            title="<%= row.parse_warnings.join('; ') %>">
                        Warnings
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
