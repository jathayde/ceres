<%= render PageHeaderComponent.new(title: "Confirm Import", subtitle: @import.original_filename) %>

<!-- Summary counts -->
<div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
  <div class="bg-white rounded-lg border border-green-200 p-4 text-center">
    <div class="text-3xl font-bold text-green-600"><%= @summary[:plants_to_create] %></div>
    <div class="text-sm text-gray-500">Plants to create</div>
  </div>
  <div class="bg-white rounded-lg border border-blue-200 p-4 text-center">
    <div class="text-3xl font-bold text-blue-600"><%= @summary[:purchases_to_create] %></div>
    <div class="text-sm text-gray-500">Purchases to create</div>
  </div>
  <div class="bg-white rounded-lg border border-purple-200 p-4 text-center">
    <div class="text-3xl font-bold text-purple-600"><%= @summary[:sources_to_create] %></div>
    <div class="text-sm text-gray-500">New sources to create</div>
  </div>
  <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
    <div class="text-3xl font-bold text-gray-600"><%= @summary[:categories_to_check] %></div>
    <div class="text-sm text-gray-500">Categories referenced</div>
  </div>
</div>

<!-- Info box -->
<div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
  <div class="flex items-start gap-3">
    <svg class="w-5 h-5 text-blue-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div class="text-sm text-blue-800">
      <p class="font-medium">What will happen:</p>
      <ul class="mt-1 list-disc list-inside space-y-1">
        <li>Duplicate variety rows are consolidated into a single Plant with multiple purchases</li>
        <li>New SeedSource records will be created and deduplicated by name</li>
        <li>PlantCategory and PlantSubcategory records will be created as needed</li>
        <li>Rows marked as used up will have <code class="bg-blue-100 px-1 rounded">used_up: true</code> set</li>
        <li>Rejected and duplicate rows are excluded</li>
        <li>The import runs as a background job and can be rolled back on failure</li>
      </ul>
    </div>
  </div>
</div>

<!-- Rows to import by sheet -->
<div class="mt-6 space-y-4">
  <h2 class="text-lg font-medium text-gray-900">Rows to import (<%= @importable_rows.size %>)</h2>

  <% @rows_by_sheet.each do |sheet_name, rows| %>
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
        <h3 class="text-sm font-medium text-gray-900">
          <%= sheet_name %>
          <span class="ml-2 text-xs text-gray-500">(<%= rows.size %> rows)</span>
        </h3>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variety</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mapped To</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% rows.each do |row| %>
              <tr class="<%= row.detected_used_up? ? 'bg-gray-50 text-gray-400' : '' %>">
                <td class="px-3 py-2 text-sm"><%= row.variety_name || '—' %></td>
                <td class="px-3 py-2 text-sm text-gray-600">
                  <%= row.mapped_plant_type_name %> &gt; <%= row.mapped_category_name %>
                  <% if row.mapped_subcategory_name.present? %>
                    &gt; <%= row.mapped_subcategory_name %>
                  <% end %>
                </td>
                <td class="px-3 py-2 text-sm"><%= row.mapped_source_name || row.seed_source_name || '—' %></td>
                <td class="px-3 py-2 text-sm whitespace-nowrap"><%= row.year_purchased || '—' %></td>
                <td class="px-3 py-2 text-sm whitespace-nowrap">
                  <% if row.detected_used_up? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Used Up</span>
                  <% end %>
                  <% if row.accepted? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Accepted</span>
                  <% elsif row.modified? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Modified</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>

<!-- Action buttons -->
<div class="mt-6 flex items-center justify-between bg-white rounded-lg border border-gray-200 p-4">
  <div>
    <%= link_to review_spreadsheet_import_path(@import), class: "text-sm text-gray-600 hover:text-gray-900 underline" do %>
      &larr; Back to review
    <% end %>
  </div>
  <div class="flex items-center gap-3">
    <div class="text-sm text-gray-500">
      <%= @importable_rows.size %> rows will be imported
    </div>
    <%= link_to execute_spreadsheet_import_path(@import),
          data: { turbo_method: :post, turbo_confirm: "Are you sure you want to import #{@importable_rows.size} rows? This will create plants, purchases, and sources in your database." },
          class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      Execute Import
    <% end %>
  </div>
</div>
