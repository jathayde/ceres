<tr id="import_row_<%= row.id %>" class="<%= row_classes(row) %>">
  <td class="px-3 py-2 text-sm whitespace-nowrap">
    <span class="text-gray-500"><%= row.sheet_name %></span>
    <span class="text-gray-900 font-medium ml-1">#<%= row.row_number %></span>
  </td>

  <td class="px-3 py-2 text-sm">
    <div class="font-medium text-gray-900"><%= row.variety_name || "—" %></div>
    <% if row.detected_used_up? %>
      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">Used Up</span>
    <% end %>
    <% if row.duplicate? %>
      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
        Duplicate
      </span>
    <% end %>
  </td>

  <td class="px-3 py-2 text-sm">
    <div class="text-gray-600"><%= row.seed_source_name || "—" %></div>
    <% if row.mapped_source_name.present? && row.mapped_source_name != row.seed_source_name %>
      <div class="text-xs text-indigo-600">→ <%= row.mapped_source_name %></div>
    <% end %>
  </td>

  <td class="px-3 py-2 text-sm whitespace-nowrap"><%= row.year_purchased || "—" %></td>

  <td class="px-3 py-2 text-sm">
    <% if row.mapping_complete? %>
      <div class="space-y-0.5">
        <div class="text-xs text-gray-500"><%= row.mapped_plant_type_name %></div>
        <div class="font-medium text-gray-900"><%= row.mapped_category_name %></div>
        <% if row.mapped_subcategory_name.present? %>
          <div class="text-xs text-gray-600"><%= row.mapped_subcategory_name %></div>
        <% end %>
      </div>
    <% elsif row.unmapped? %>
      <span class="text-gray-400 text-xs">Pending...</span>
    <% else %>
      <span class="text-gray-400">—</span>
    <% end %>
    <% if row.mapping_notes.present? %>
      <div class="text-xs text-gray-500 mt-1"><%= row.mapping_notes %></div>
    <% end %>
  </td>

  <td class="px-3 py-2 text-sm whitespace-nowrap">
    <% if row.mapping_confidence.present? %>
      <% confidence_pct = (row.mapping_confidence * 100).round %>
      <span class="<%= confidence_pct >= 80 ? 'text-green-600' : confidence_pct >= 50 ? 'text-amber-600' : 'text-red-600' %> font-medium">
        <%= confidence_pct %>%
      </span>
    <% end %>
  </td>

  <td class="px-3 py-2 text-sm whitespace-nowrap">
    <% case row.mapping_status %>
    <% when "unmapped" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Unmapped</span>
    <% when "ai_mapped" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">AI Mapped</span>
    <% when "accepted" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Accepted</span>
    <% when "modified" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Modified</span>
    <% when "rejected" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Rejected</span>
    <% end %>
  </td>

  <td class="px-3 py-2 text-sm whitespace-nowrap">
    <% if row.ai_mapped? %>
      <div class="flex items-center gap-1">
        <%= link_to update_row_mapping_spreadsheet_import_path(row.spreadsheet_import, row_id: row.id, action_type: "accept"),
              data: { turbo_method: :patch },
              class: "inline-flex items-center px-2 py-1 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 rounded transition-colors",
              title: "Accept mapping" do %>
          Accept
        <% end %>
        <button type="button"
                data-controller="edit-mapping"
                data-action="click->edit-mapping#toggle"
                data-edit-mapping-row-id-value="<%= row.id %>"
                class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded transition-colors"
                title="Edit mapping">
          Edit
        </button>
        <%= link_to update_row_mapping_spreadsheet_import_path(row.spreadsheet_import, row_id: row.id, action_type: "reject"),
              data: { turbo_method: :patch },
              class: "inline-flex items-center px-2 py-1 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 rounded transition-colors",
              title: "Reject mapping" do %>
          Reject
        <% end %>
      </div>

      <!-- Edit form (hidden by default) -->
      <div id="edit_form_<%= row.id %>" class="hidden mt-2">
        <%= form_with url: update_row_mapping_spreadsheet_import_path(row.spreadsheet_import, row_id: row.id, action_type: "modify"),
              method: :patch, class: "space-y-2", data: { controller: "mapping-select" } do |f| %>
          <div>
            <select name="mapped_plant_type_name" class="block w-full text-xs rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                    data-action="change->mapping-select#updateCategories">
              <% plant_types.each do |pt| %>
                <option value="<%= pt.name %>" <%= "selected" if pt.name == row.mapped_plant_type_name %>><%= pt.name %></option>
              <% end %>
            </select>
          </div>
          <div>
            <select name="mapped_category_name" class="block w-full text-xs rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <% plant_types.each do |pt| %>
                <% pt.plant_categories.each do |cat| %>
                  <option value="<%= cat.name %>" data-plant-type="<%= pt.name %>" <%= "selected" if cat.name == row.mapped_category_name %>><%= cat.name %></option>
                <% end %>
              <% end %>
            </select>
          </div>
          <div>
            <input type="text" name="mapped_subcategory_name" value="<%= row.mapped_subcategory_name %>"
                   placeholder="Subcategory (optional)"
                   class="block w-full text-xs rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          <div>
            <input type="text" name="mapped_source_name" value="<%= row.mapped_source_name || row.seed_source_name %>"
                   placeholder="Source name"
                   class="block w-full text-xs rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
          </div>
          <button type="submit" class="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded transition-colors">
            Save
          </button>
        <% end %>
      </div>
    <% elsif row.accepted? || row.modified? %>
      <%= link_to update_row_mapping_spreadsheet_import_path(row.spreadsheet_import, row_id: row.id, action_type: "reject"),
            data: { turbo_method: :patch },
            class: "inline-flex items-center px-2 py-1 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 rounded transition-colors",
            title: "Reject mapping" do %>
        Reject
      <% end %>
    <% end %>
  </td>
</tr>
