## Codebase Patterns
- Rails 8.1.2 app with PostgreSQL, Tailwind CSS 4, Hotwire/Turbo, Importmap
- RSpec for testing with shoulda-matchers, factory_bot, faker
- Rubocop with rails-omakase style guide — run `bin/rubocop` for linting
- Run `bundle exec rspec` for tests
- Solid Queue for background jobs (production), async adapter in dev/test
- ViewComponent for reusable UI components
- pg_search gem for full-text search
- Anthropic Ruby SDK gem for AI features
- Root route: `home#index`
- Project directory: `/Users/jathayde/Development/HomesteadTrack/ceres`
- Rubocop requires spaces inside array brackets: `[ :a, :b ]` not `[:a, :b]`
- Viability filtering uses raw SQL subqueries to avoid DISTINCT + ORDER BY conflicts in PostgreSQL
- Filter params are preserved across search/navigation via hidden fields in search bar partial
- Use `default_scope { order(:position) }` for position-ordered models
- Uniqueness scoped validations: `validates :name, uniqueness: { scope: :parent_id }`
- PostgreSQL array columns: `t.string :field, array: true, default: []`
- Enums: integer column in migration, `enum :field, { key: 0, key2: 1 }` in model
- Use `references_urls` not `references` as column name to avoid Rails method conflict
- Optional belongs_to: `belongs_to :assoc, optional: true` with `null: true` in migration
- Unique has_one: `index: { unique: true }` on references in migration + `validates :foreign_key_id, uniqueness: true` in model
- Viability fallback chain: `plant.expected_viability_years || plant.plant_category.expected_viability_years`
- ViewComponent specs: require `spec/support/view_component.rb` which includes `ViewComponent::TestHelpers` and `Capybara::RSpecMatchers` for `type: :component`
- ViewComponent specs use `render_inline(component)` and Capybara's `page` matchers
- Capybara gem is required for ViewComponent testing (added to test group)
- Nav routes: `seed_sources_path`, `viability_audit_path`, root as Inventory
- Stimulus controllers go in `app/javascript/controllers/` and auto-register via eager loading

---

## 2026-02-16 - US-001
- Initialized Rails 8.1.2 application with PostgreSQL
- Configured Tailwind CSS, Hotwire/Turbo, Solid Queue
- Added and configured RSpec with shoulda-matchers, factory_bot, faker
- Added pg_search, view_component, and anthropic gems
- Set up root route to home#index with basic landing page
- Health check available at /up
- Files changed: All initial Rails scaffold files + Gemfile modifications, spec/ setup
- **Learnings for future iterations:**
  - Rails 8 ships with Solid Queue, Solid Cache, Solid Cable out of the box
  - `rails new . --database=postgresql --css=tailwind --skip-test` is the right incantation for this stack
  - Use `bin/rubocop` for linting, `bundle exec rspec` for tests
  - The `.rspec` file has `--require spec_helper`; rails_helper must be required explicitly or via support files
  - `config.infer_spec_type_from_file_location!` was uncommented to enable automatic spec type inference
---

## 2026-02-16 - US-003
- Created PlantCategory model with: plant_type_id (FK, not null), name (string, not null), latin_genus, latin_species, expected_viability_years, description, position
- Added composite unique index on [plant_type_id, name]
- Model validates name presence and uniqueness scoped to plant_type_id
- Default scope orders by position
- Added `has_many :plant_categories, dependent: :destroy` to PlantType
- Created factory and comprehensive model specs (associations, validations, scoped uniqueness, default scope, factory)
- Files changed:
  - `db/migrate/20260216233802_create_plant_categories.rb` (new)
  - `app/models/plant_category.rb` (new)
  - `app/models/plant_type.rb` (updated — added association)
  - `spec/models/plant_category_spec.rb` (new)
  - `spec/models/plant_type_spec.rb` (updated — added association test)
  - `spec/factories/plant_categories.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Rubocop enforces `[ :a, :b ]` spacing inside array brackets (rails-omakase style)
  - Follow existing pattern: model validations + default_scope, shoulda-matchers for spec, factory with sequences
  - Always add association spec to both sides (belongs_to and has_many)
---

## 2026-02-16 - US-004
- Created PlantSubcategory model with: plant_category_id (FK, not null), name (string, not null), description, position
- Added composite unique index on [plant_category_id, name]
- Model validates name presence and uniqueness scoped to plant_category_id
- Default scope orders by position
- Added `has_many :plant_subcategories, dependent: :destroy` to PlantCategory
- Created factory and comprehensive model specs (associations, validations, scoped uniqueness, default scope, factory)
- Files changed:
  - `db/migrate/20260216234018_create_plant_subcategories.rb` (new)
  - `app/models/plant_subcategory.rb` (new)
  - `app/models/plant_category.rb` (updated — added has_many association)
  - `spec/models/plant_subcategory_spec.rb` (new)
  - `spec/models/plant_category_spec.rb` (updated — added association test)
  - `spec/factories/plant_subcategories.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Pattern is well-established: migration with null/unique constraints, model with belongs_to/validations/default_scope, factory with sequences, spec mirroring parent model spec structure
  - Each new taxonomy model follows the same template — future models (Plant, etc.) will differ more
---

## 2026-02-16 - US-005
- Created Plant model with: plant_category_id (FK, not null), plant_subcategory_id (FK, nullable), name (string, not null), latin_name, heirloom (boolean, default false), days_to_harvest_min, days_to_harvest_max, winter_hardy (enum), life_cycle (enum, not null), planting_seasons (string array), expected_viability_years, references_urls (text array), notes
- Enum definitions: winter_hardy (hardy/semi_hardy/tender), life_cycle (annual/biennial/perennial)
- belongs_to :plant_category, belongs_to :plant_subcategory (optional)
- Added `has_many :plants, dependent: :destroy` to both PlantCategory and PlantSubcategory
- Validates name and life_cycle presence
- Created factory and comprehensive model specs (associations, validations, enums, optional subcategory, defaults, factory)
- Files changed:
  - `db/migrate/20260216234254_create_plants.rb` (new)
  - `app/models/plant.rb` (new)
  - `app/models/plant_category.rb` (updated — added has_many :plants)
  - `app/models/plant_subcategory.rb` (updated — added has_many :plants)
  - `spec/models/plant_spec.rb` (new)
  - `spec/models/plant_category_spec.rb` (updated — added association test)
  - `spec/models/plant_subcategory_spec.rb` (updated — added association test)
  - `spec/factories/plants.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Named the column `references_urls` instead of `references` to avoid conflict with Rails' `references` method
  - PostgreSQL array columns: use `array: true, default: []` in migration
  - Enum columns use integer type in migration, `enum :field, { key: value }` in model
  - `optional: true` on belongs_to for nullable FK associations
  - Plant model is the first model that diverges from the taxonomy template — has enums, optional association, array columns
---

## 2026-02-16 - US-006
- Created SeedSource model with: name (string, unique, not null), url (string), notes (text), timestamps
- Added unique index on name
- Model validates name presence and uniqueness
- Created factory and comprehensive model specs (validations, factory uniqueness)
- Files changed:
  - `db/migrate/20260216234556_create_seed_sources.rb` (new)
  - `app/models/seed_source.rb` (new)
  - `spec/models/seed_source_spec.rb` (new)
  - `spec/factories/seed_sources.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - SeedSource is a simple standalone model — no position ordering, no parent association
  - Future US-007 (SeedPurchase) will need `has_many :seed_purchases` added to this model
---

## 2026-02-16 - US-007
- Created SeedPurchase model with: plant_id (FK, not null), seed_source_id (FK, not null), year_purchased (integer, not null), lot_number, germination_rate (decimal 5,4), weight_oz (decimal), seed_count (integer), packet_count (integer, default 1), cost_cents (integer), used_up (boolean, default false), used_up_at (date), reorder_url, notes
- belongs_to :plant, belongs_to :seed_source
- Added `has_many :seed_purchases, dependent: :destroy` to both Plant and SeedSource
- Validates year_purchased presence, germination_rate between 0 and 1 when present
- Created factory and comprehensive model specs (associations, validations, germination rate edge cases, defaults, factory)
- Files changed:
  - `db/migrate/20260216234745_create_seed_purchases.rb` (new)
  - `app/models/seed_purchase.rb` (new)
  - `app/models/plant.rb` (updated — added has_many :seed_purchases)
  - `app/models/seed_source.rb` (updated — added has_many :seed_purchases)
  - `spec/models/seed_purchase_spec.rb` (new)
  - `spec/models/plant_spec.rb` (updated — added association test)
  - `spec/models/seed_source_spec.rb` (updated — added association test)
  - `spec/factories/seed_purchases.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - SeedPurchase has dual belongs_to (plant + seed_source) — both required
  - Germination rate stored as decimal(5,4) — validates 0..1 range with allow_nil
  - `cost_cents` uses integer (not decimal) for money — standard pattern
  - `used_up_at` is a date (not datetime) since precision beyond day isn't needed
  - US-009 will add viability calculation methods to this model
---

## 2026-02-16 - US-008
- Created GrowingGuide model with: plant_id (FK, unique, not null), overview, soil_requirements, sun_exposure (enum), water_needs (enum), spacing_inches, row_spacing_inches, planting_depth_inches (decimal), germination_temp_min_f, germination_temp_max_f, germination_days_min, germination_days_max, growing_tips, harvest_notes, seed_saving_notes, ai_generated (boolean, default false), ai_generated_at (datetime)
- belongs_to :plant with unique constraint (one guide per plant)
- Plant has_one :growing_guide, dependent: :destroy
- Enum definitions: sun_exposure (full_sun/partial_shade/full_shade), water_needs (low/moderate/high)
- Created factory and comprehensive model specs (association, uniqueness, enums, defaults, factory)
- Files changed:
  - `db/migrate/20260216235121_create_growing_guides.rb` (new)
  - `app/models/growing_guide.rb` (new)
  - `app/models/plant.rb` (updated — added has_one :growing_guide)
  - `spec/models/growing_guide_spec.rb` (new)
  - `spec/models/plant_spec.rb` (updated — added association test)
  - `spec/factories/growing_guides.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - For has_one with unique constraint: use `index: { unique: true }` on references in migration + `validates :plant_id, uniqueness: true` in model
  - GrowingGuide is a 1:1 with Plant — mostly nullable text/integer fields, no default scope needed
  - US-021 will use ai_generated/ai_generated_at fields for AI growing guide research feature
---

## 2026-02-16 - US-009
- Implemented seed viability calculation logic on SeedPurchase model
- Added `viability_status` method returning :viable, :test, :expired, :used_up, or :unknown
- Added `viability_years_remaining` method returning positive/zero/negative integer or nil
- Added `seed_age` method computing current year minus year_purchased
- Viability uses plant-level `expected_viability_years`, falling back to category-level
- Viable: age <= expected_years; Test: age > expected_years AND age <= expected_years + 2; Expired: age > expected_years + 2
- Used-up purchases return :used_up; missing viability data returns :unknown / nil
- Files changed:
  - `app/models/seed_purchase.rb` (updated — added viability methods)
  - `spec/models/seed_purchase_spec.rb` (updated — added 17 viability specs)
- **Learnings for future iterations:**
  - Viability is computed dynamically (not stored) — `seed_age` is `Date.current.year - year_purchased`
  - Plant-level `expected_viability_years` takes priority over category-level (fallback chain)
  - The `:unknown` status handles cases where no viability data exists at either level
  - `viability_years_remaining` can be negative (useful for sorting by urgency in US-024 viability dashboard)
  - No migration needed — this story is pure business logic on existing columns
---

## 2026-02-16 - US-010
- Populated `expected_viability_years` on PlantCategory records via seed data
- Added 36 PlantCategory records across all 5 PlantTypes with viability years and latin genus/species
- Vegetable categories (21): Onion(2), Leek(2), Chive(2), Parsnip(2), Salsify(2), Pepper(3), Corn(3), Bean(4), Pea(4), Carrot(4), Celery(4), Lettuce(5), Endive(5), Brassica(5), Beet(5), Chard(5), Tomato(5), Eggplant(5), Cucurbit(6), Radish(5), Turnip(5)
- Grain categories (4): Wheat(4), Oat(3), Rye(3), Barley(3)
- Herb categories (4): Basil(5), Cilantro(3), Dill(5), Parsley(3)
- Flower categories (4): Sunflower(5), Zinnia(5), Marigold(3), Cosmos(4)
- Cover Crop categories (3): Clover(3), Vetch(3), Buckwheat(3)
- Seed task is idempotent using `find_or_create_by!`
- Files changed:
  - `db/seeds.rb` (updated — added PlantCategory seed data)
- **Learnings for future iterations:**
  - `find_or_create_by!` with a block is the idempotent seed pattern — block only runs on create, not on find
  - PlantCategory seed data covers all required viability values from the PRD acceptance criteria
  - Categories span all PlantTypes, not just Vegetable — Grain, Herb, Flower, Cover Crop all have entries
  - No migration needed — categories are runtime data, not schema changes
---

## 2026-02-16 - US-011
- Implemented application layout with fixed header navigation
- Created 3 ViewComponents: NavBarComponent, ViabilityBadgeComponent, PageHeaderComponent
- NavBarComponent: fixed header with Ceres branding, three nav links (Inventory, Seed Sources, Viability Audit), active state highlighting, responsive mobile hamburger menu
- ViabilityBadgeComponent: color-coded status badges (green=viable, amber=test, red=expired, gray=used_up/unknown)
- PageHeaderComponent: reusable page header with title, optional subtitle, and actions slot
- Added Stimulus `nav-toggle` controller for mobile menu toggle
- Added routes: `resources :seed_sources, only: [:index]` and `get "viability_audit"`
- Created placeholder controllers and views for SeedSources and ViabilityAudit
- Updated application layout with `bg-gray-50` body, fixed nav, and proper main content padding
- Added Capybara gem for ViewComponent test support
- Created `spec/support/view_component.rb` with ViewComponent::TestHelpers and Capybara::RSpecMatchers
- 21 component specs covering nav active states, badge styles, page header slots
- Files changed:
  - `Gemfile` / `Gemfile.lock` (updated — added capybara)
  - `app/components/nav_bar_component.rb` + `.html.erb` (new)
  - `app/components/viability_badge_component.rb` (new)
  - `app/components/page_header_component.rb` + `.html.erb` (new)
  - `app/controllers/seed_sources_controller.rb` (new)
  - `app/controllers/viability_audit_controller.rb` (new)
  - `app/javascript/controllers/nav_toggle_controller.js` (new)
  - `app/views/home/index.html.erb` (updated — uses PageHeaderComponent)
  - `app/views/layouts/application.html.erb` (updated — NavBarComponent, styling)
  - `app/views/seed_sources/index.html.erb` (new)
  - `app/views/viability_audit/index.html.erb` (new)
  - `config/routes.rb` (updated — seed_sources, viability_audit routes)
  - `spec/components/nav_bar_component_spec.rb` (new)
  - `spec/components/viability_badge_component_spec.rb` (new)
  - `spec/components/page_header_component_spec.rb` (new)
  - `spec/support/view_component.rb` (new)
- **Learnings for future iterations:**
  - ViewComponent `render_inline` requires capybara gem — must be in Gemfile test group
  - `spec/support/view_component.rb` configures `ViewComponent::TestHelpers` and `Capybara::RSpecMatchers` for `type: :component` specs
  - ViewComponent `Data.define` is a clean Ruby 3.2+ way to define simple value objects (used for NavItem)
  - `class_names` helper in ERB handles conditional Tailwind classes cleanly
  - Stimulus controllers auto-register when placed in `app/javascript/controllers/` — no manual registration needed
  - Fixed header with `fixed top-0 left-0 right-0 z-50` plus `pt-20` on main content for clearance
---

## 2026-02-16 - US-019
- Implemented inventory quick filters: viability status (Viable/Needs Testing/Expired), Heirloom toggle, Seed Source dropdown
- Added Plant model scopes: `.heirloom`, `.with_seed_source(id)`, `.with_viability_status(status)`
- Viability filter uses raw SQL subquery to avoid DISTINCT + ORDER BY conflicts with PostgreSQL
- Filters combine with each other (AND logic), with search, and with taxonomy navigation
- Active filters visually indicated with filled/highlighted button styles; clear all filters button when any filter active
- Search bar preserves filter params as hidden fields so filters persist across search input changes
- Created Stimulus `inventory-filters` controller for seed source dropdown Turbo Frame navigation
- Filters partial (`_filters.html.erb`) renders on both index and browse views
- Added 21 new specs: 10 model specs for new scopes, 11 request specs for filter behavior
- Files changed:
  - `app/models/plant.rb` (updated — added heirloom, with_seed_source, with_viability_status scopes)
  - `app/controllers/inventory_controller.rb` (updated — added load_filters, apply filters in load_plants)
  - `app/views/inventory/_filters.html.erb` (new — filter buttons and seed source dropdown)
  - `app/views/inventory/_search_bar.html.erb` (updated — hidden fields for filter params)
  - `app/views/inventory/index.html.erb` (updated — renders filters partial)
  - `app/views/inventory/browse.html.erb` (updated — renders filters partial)
  - `app/javascript/controllers/inventory_filters_controller.js` (new — Stimulus controller for source dropdown)
  - `spec/models/plant_spec.rb` (updated — added scope specs)
  - `spec/requests/inventory_spec.rb` (updated — added filter specs)
- **Learnings for future iterations:**
  - PostgreSQL `SELECT DISTINCT` requires ORDER BY columns to be in the SELECT list — use subqueries (`WHERE id IN (SELECT ...)`) instead of `.distinct` when ordering by joined table columns
  - Raw SQL subqueries with aliased tables (`sp`, `p`, `pc`) avoid conflicts when pg_search also joins the same tables
  - `request.query_parameters.except("key")` in views is useful for toggling filters while preserving other params
  - Filter state must be propagated in three ways: URL params (links), hidden fields (search form), and Stimulus (select dropdown)
  - Turbo Frame `src` assignment triggers frame navigation without a full page reload
---

## 2026-02-17 - US-023
- Implemented AI Viability Data Enrichment for PlantCategory records
- Added `expected_viability_years_ai_populated` boolean column to `plant_categories` table
- Created `ViabilityDataEnrichmentJob` background job that calls Anthropic Claude API to research seed viability years for a given plant category
- Added `research_viability` member action on `PlantCategoriesController`
- Added nested member route: `POST /plant_types/:plant_type_id/plant_categories/:id/research_viability`
- Updated plant categories index view with:
  - "Research" button (lightbulb icon, indigo color) for categories without viability data
  - "AI" badge (blue) on categories with AI-populated viability data
  - Turbo Stream subscriptions for real-time updates when AI job completes
- Created `_viability_cell.html.erb` partial for Turbo Stream broadcast replacements
- User can override AI-suggested values at any time via the existing edit form
- Added 16 job specs and 3 request specs (total 19 new tests, all passing)
- Files changed:
  - `db/migrate/20260217012830_add_expected_viability_years_ai_populated_to_plant_categories.rb` (new)
  - `app/jobs/viability_data_enrichment_job.rb` (new)
  - `app/controllers/plant_categories_controller.rb` (updated — added research_viability action)
  - `app/views/plant_categories/index.html.erb` (updated — research button, AI badge, Turbo Stream)
  - `app/views/plant_categories/_viability_cell.html.erb` (new — partial for viability cell)
  - `config/routes.rb` (updated — added research_viability member route)
  - `db/schema.rb` (auto-updated by migration)
  - `spec/jobs/viability_data_enrichment_job_spec.rb` (new)
  - `spec/requests/plant_categories_spec.rb` (updated — added 6 new specs)
- **Learnings for future iterations:**
  - AI job pattern is well-established: `call_anthropic` → `parse_response` → `save_*` → `broadcast_update`, with `api_key` helper
  - For nested resource actions (plant_categories nested under plant_types), use `member do ... end` inside the nested block
  - The `expected_viability_years_ai_populated` boolean follows the same pattern as `latin_name_ai_populated` and `latin_genus_ai_populated`
  - Turbo Stream broadcast targets must match the DOM element ID exactly for real-time updates
  - Rubocop can't parse ERB files — only lint `.rb` files
---
