## Codebase Patterns
- Rails 8.1.2 app with PostgreSQL, Tailwind CSS 4, Hotwire/Turbo, Importmap
- RSpec for testing with shoulda-matchers, factory_bot, faker
- Rubocop with rails-omakase style guide — run `bin/rubocop` for linting
- Run `bundle exec rspec` for tests
- Solid Queue for background jobs (production), async adapter in dev/test
- ViewComponent for reusable UI components
- pg_search gem for full-text search
- Anthropic Ruby SDK gem for AI features
- Root route: `home#index`
- Project directory: `/Users/jathayde/Development/HomesteadTrack/ceres`
- Rubocop requires spaces inside array brackets: `[ :a, :b ]` not `[:a, :b]`
- Viability filtering uses raw SQL subqueries to avoid DISTINCT + ORDER BY conflicts in PostgreSQL
- Filter params are preserved across search/navigation via hidden fields in search bar partial
- Use `default_scope { order(:position) }` for position-ordered models
- Uniqueness scoped validations: `validates :name, uniqueness: { scope: :parent_id }`
- PostgreSQL array columns: `t.string :field, array: true, default: []`
- Enums: integer column in migration, `enum :field, { key: 0, key2: 1 }` in model
- Use `references_urls` not `references` as column name to avoid Rails method conflict
- Optional belongs_to: `belongs_to :assoc, optional: true` with `null: true` in migration
- Unique has_one: `index: { unique: true }` on references in migration + `validates :foreign_key_id, uniqueness: true` in model
- Viability fallback chain: `plant.expected_viability_years || plant.plant_category.expected_viability_years`
- ViewComponent specs: require `spec/support/view_component.rb` which includes `ViewComponent::TestHelpers` and `Capybara::RSpecMatchers` for `type: :component`
- ViewComponent specs use `render_inline(component)` and Capybara's `page` matchers
- Capybara gem is required for ViewComponent testing (added to test group)
- Nav routes: `seed_sources_path`, `viability_audit_path`, root as Inventory
- Stimulus controllers go in `app/javascript/controllers/` and auto-register via eager loading
- `roo` gem for xlsx parsing + `csv` gem (required explicitly for Ruby 3.4+) + `caxlsx` gem for test fixture generation
- Active Storage is available for file uploads (tables installed)
- Column matcher patterns: use ordered array of [field, pattern] pairs; break after first match per header to prevent ambiguous column assignments
- `spec/support/xlsx_helper.rb` provides `create_test_xlsx` and `create_standard_test_xlsx` for xlsx fixture generation in tests
- AI batch processing pattern: send batches of 20 rows to Anthropic API with existing taxonomy as context, parse JSON array response by index
- SpreadsheetImport status flow: pending → parsing → parsed → mapping → mapped → executing → executed (failed from any step)
- SpreadsheetImportRow mapping_status enum: unmapped → ai_mapped → accepted/modified/rejected
- Factory `:with_file` trait required for SpreadsheetImport creation (file validation on create)

---

## 2026-02-16 - US-001
- Initialized Rails 8.1.2 application with PostgreSQL
- Configured Tailwind CSS, Hotwire/Turbo, Solid Queue
- Added and configured RSpec with shoulda-matchers, factory_bot, faker
- Added pg_search, view_component, and anthropic gems
- Set up root route to home#index with basic landing page
- Health check available at /up
- Files changed: All initial Rails scaffold files + Gemfile modifications, spec/ setup
- **Learnings for future iterations:**
  - Rails 8 ships with Solid Queue, Solid Cache, Solid Cable out of the box
  - `rails new . --database=postgresql --css=tailwind --skip-test` is the right incantation for this stack
  - Use `bin/rubocop` for linting, `bundle exec rspec` for tests
  - The `.rspec` file has `--require spec_helper`; rails_helper must be required explicitly or via support files
  - `config.infer_spec_type_from_file_location!` was uncommented to enable automatic spec type inference
---

## 2026-02-16 - US-003
- Created PlantCategory model with: plant_type_id (FK, not null), name (string, not null), latin_genus, latin_species, expected_viability_years, description, position
- Added composite unique index on [plant_type_id, name]
- Model validates name presence and uniqueness scoped to plant_type_id
- Default scope orders by position
- Added `has_many :plant_categories, dependent: :destroy` to PlantType
- Created factory and comprehensive model specs (associations, validations, scoped uniqueness, default scope, factory)
- Files changed:
  - `db/migrate/20260216233802_create_plant_categories.rb` (new)
  - `app/models/plant_category.rb` (new)
  - `app/models/plant_type.rb` (updated — added association)
  - `spec/models/plant_category_spec.rb` (new)
  - `spec/models/plant_type_spec.rb` (updated — added association test)
  - `spec/factories/plant_categories.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Rubocop enforces `[ :a, :b ]` spacing inside array brackets (rails-omakase style)
  - Follow existing pattern: model validations + default_scope, shoulda-matchers for spec, factory with sequences
  - Always add association spec to both sides (belongs_to and has_many)
---

## 2026-02-16 - US-004
- Created PlantSubcategory model with: plant_category_id (FK, not null), name (string, not null), description, position
- Added composite unique index on [plant_category_id, name]
- Model validates name presence and uniqueness scoped to plant_category_id
- Default scope orders by position
- Added `has_many :plant_subcategories, dependent: :destroy` to PlantCategory
- Created factory and comprehensive model specs (associations, validations, scoped uniqueness, default scope, factory)
- Files changed:
  - `db/migrate/20260216234018_create_plant_subcategories.rb` (new)
  - `app/models/plant_subcategory.rb` (new)
  - `app/models/plant_category.rb` (updated — added has_many association)
  - `spec/models/plant_subcategory_spec.rb` (new)
  - `spec/models/plant_category_spec.rb` (updated — added association test)
  - `spec/factories/plant_subcategories.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Pattern is well-established: migration with null/unique constraints, model with belongs_to/validations/default_scope, factory with sequences, spec mirroring parent model spec structure
  - Each new taxonomy model follows the same template — future models (Plant, etc.) will differ more
---

## 2026-02-16 - US-005
- Created Plant model with: plant_category_id (FK, not null), plant_subcategory_id (FK, nullable), name (string, not null), latin_name, heirloom (boolean, default false), days_to_harvest_min, days_to_harvest_max, winter_hardy (enum), life_cycle (enum, not null), planting_seasons (string array), expected_viability_years, references_urls (text array), notes
- Enum definitions: winter_hardy (hardy/semi_hardy/tender), life_cycle (annual/biennial/perennial)
- belongs_to :plant_category, belongs_to :plant_subcategory (optional)
- Added `has_many :plants, dependent: :destroy` to both PlantCategory and PlantSubcategory
- Validates name and life_cycle presence
- Created factory and comprehensive model specs (associations, validations, enums, optional subcategory, defaults, factory)
- Files changed:
  - `db/migrate/20260216234254_create_plants.rb` (new)
  - `app/models/plant.rb` (new)
  - `app/models/plant_category.rb` (updated — added has_many :plants)
  - `app/models/plant_subcategory.rb` (updated — added has_many :plants)
  - `spec/models/plant_spec.rb` (new)
  - `spec/models/plant_category_spec.rb` (updated — added association test)
  - `spec/models/plant_subcategory_spec.rb` (updated — added association test)
  - `spec/factories/plants.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - Named the column `references_urls` instead of `references` to avoid conflict with Rails' `references` method
  - PostgreSQL array columns: use `array: true, default: []` in migration
  - Enum columns use integer type in migration, `enum :field, { key: value }` in model
  - `optional: true` on belongs_to for nullable FK associations
  - Plant model is the first model that diverges from the taxonomy template — has enums, optional association, array columns
---

## 2026-02-16 - US-006
- Created SeedSource model with: name (string, unique, not null), url (string), notes (text), timestamps
- Added unique index on name
- Model validates name presence and uniqueness
- Created factory and comprehensive model specs (validations, factory uniqueness)
- Files changed:
  - `db/migrate/20260216234556_create_seed_sources.rb` (new)
  - `app/models/seed_source.rb` (new)
  - `spec/models/seed_source_spec.rb` (new)
  - `spec/factories/seed_sources.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - SeedSource is a simple standalone model — no position ordering, no parent association
  - Future US-007 (SeedPurchase) will need `has_many :seed_purchases` added to this model
---

## 2026-02-16 - US-007
- Created SeedPurchase model with: plant_id (FK, not null), seed_source_id (FK, not null), year_purchased (integer, not null), lot_number, germination_rate (decimal 5,4), weight_oz (decimal), seed_count (integer), packet_count (integer, default 1), cost_cents (integer), used_up (boolean, default false), used_up_at (date), reorder_url, notes
- belongs_to :plant, belongs_to :seed_source
- Added `has_many :seed_purchases, dependent: :destroy` to both Plant and SeedSource
- Validates year_purchased presence, germination_rate between 0 and 1 when present
- Created factory and comprehensive model specs (associations, validations, germination rate edge cases, defaults, factory)
- Files changed:
  - `db/migrate/20260216234745_create_seed_purchases.rb` (new)
  - `app/models/seed_purchase.rb` (new)
  - `app/models/plant.rb` (updated — added has_many :seed_purchases)
  - `app/models/seed_source.rb` (updated — added has_many :seed_purchases)
  - `spec/models/seed_purchase_spec.rb` (new)
  - `spec/models/plant_spec.rb` (updated — added association test)
  - `spec/models/seed_source_spec.rb` (updated — added association test)
  - `spec/factories/seed_purchases.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - SeedPurchase has dual belongs_to (plant + seed_source) — both required
  - Germination rate stored as decimal(5,4) — validates 0..1 range with allow_nil
  - `cost_cents` uses integer (not decimal) for money — standard pattern
  - `used_up_at` is a date (not datetime) since precision beyond day isn't needed
  - US-009 will add viability calculation methods to this model
---

## 2026-02-16 - US-008
- Created GrowingGuide model with: plant_id (FK, unique, not null), overview, soil_requirements, sun_exposure (enum), water_needs (enum), spacing_inches, row_spacing_inches, planting_depth_inches (decimal), germination_temp_min_f, germination_temp_max_f, germination_days_min, germination_days_max, growing_tips, harvest_notes, seed_saving_notes, ai_generated (boolean, default false), ai_generated_at (datetime)
- belongs_to :plant with unique constraint (one guide per plant)
- Plant has_one :growing_guide, dependent: :destroy
- Enum definitions: sun_exposure (full_sun/partial_shade/full_shade), water_needs (low/moderate/high)
- Created factory and comprehensive model specs (association, uniqueness, enums, defaults, factory)
- Files changed:
  - `db/migrate/20260216235121_create_growing_guides.rb` (new)
  - `app/models/growing_guide.rb` (new)
  - `app/models/plant.rb` (updated — added has_one :growing_guide)
  - `spec/models/growing_guide_spec.rb` (new)
  - `spec/models/plant_spec.rb` (updated — added association test)
  - `spec/factories/growing_guides.rb` (new)
  - `db/schema.rb` (auto-updated by migration)
- **Learnings for future iterations:**
  - For has_one with unique constraint: use `index: { unique: true }` on references in migration + `validates :plant_id, uniqueness: true` in model
  - GrowingGuide is a 1:1 with Plant — mostly nullable text/integer fields, no default scope needed
  - US-021 will use ai_generated/ai_generated_at fields for AI growing guide research feature
---

## 2026-02-16 - US-009
- Implemented seed viability calculation logic on SeedPurchase model
- Added `viability_status` method returning :viable, :test, :expired, :used_up, or :unknown
- Added `viability_years_remaining` method returning positive/zero/negative integer or nil
- Added `seed_age` method computing current year minus year_purchased
- Viability uses plant-level `expected_viability_years`, falling back to category-level
- Viable: age <= expected_years; Test: age > expected_years AND age <= expected_years + 2; Expired: age > expected_years + 2
- Used-up purchases return :used_up; missing viability data returns :unknown / nil
- Files changed:
  - `app/models/seed_purchase.rb` (updated — added viability methods)
  - `spec/models/seed_purchase_spec.rb` (updated — added 17 viability specs)
- **Learnings for future iterations:**
  - Viability is computed dynamically (not stored) — `seed_age` is `Date.current.year - year_purchased`
  - Plant-level `expected_viability_years` takes priority over category-level (fallback chain)
  - The `:unknown` status handles cases where no viability data exists at either level
  - `viability_years_remaining` can be negative (useful for sorting by urgency in US-024 viability dashboard)
  - No migration needed — this story is pure business logic on existing columns
---

## 2026-02-16 - US-010
- Populated `expected_viability_years` on PlantCategory records via seed data
- Added 36 PlantCategory records across all 5 PlantTypes with viability years and latin genus/species
- Vegetable categories (21): Onion(2), Leek(2), Chive(2), Parsnip(2), Salsify(2), Pepper(3), Corn(3), Bean(4), Pea(4), Carrot(4), Celery(4), Lettuce(5), Endive(5), Brassica(5), Beet(5), Chard(5), Tomato(5), Eggplant(5), Cucurbit(6), Radish(5), Turnip(5)
- Grain categories (4): Wheat(4), Oat(3), Rye(3), Barley(3)
- Herb categories (4): Basil(5), Cilantro(3), Dill(5), Parsley(3)
- Flower categories (4): Sunflower(5), Zinnia(5), Marigold(3), Cosmos(4)
- Cover Crop categories (3): Clover(3), Vetch(3), Buckwheat(3)
- Seed task is idempotent using `find_or_create_by!`
- Files changed:
  - `db/seeds.rb` (updated — added PlantCategory seed data)
- **Learnings for future iterations:**
  - `find_or_create_by!` with a block is the idempotent seed pattern — block only runs on create, not on find
  - PlantCategory seed data covers all required viability values from the PRD acceptance criteria
  - Categories span all PlantTypes, not just Vegetable — Grain, Herb, Flower, Cover Crop all have entries
  - No migration needed — categories are runtime data, not schema changes
---

## 2026-02-16 - US-011
- Implemented application layout with fixed header navigation
- Created 3 ViewComponents: NavBarComponent, ViabilityBadgeComponent, PageHeaderComponent
- NavBarComponent: fixed header with Ceres branding, three nav links (Inventory, Seed Sources, Viability Audit), active state highlighting, responsive mobile hamburger menu
- ViabilityBadgeComponent: color-coded status badges (green=viable, amber=test, red=expired, gray=used_up/unknown)
- PageHeaderComponent: reusable page header with title, optional subtitle, and actions slot
- Added Stimulus `nav-toggle` controller for mobile menu toggle
- Added routes: `resources :seed_sources, only: [:index]` and `get "viability_audit"`
- Created placeholder controllers and views for SeedSources and ViabilityAudit
- Updated application layout with `bg-gray-50` body, fixed nav, and proper main content padding
- Added Capybara gem for ViewComponent test support
- Created `spec/support/view_component.rb` with ViewComponent::TestHelpers and Capybara::RSpecMatchers
- 21 component specs covering nav active states, badge styles, page header slots
- Files changed:
  - `Gemfile` / `Gemfile.lock` (updated — added capybara)
  - `app/components/nav_bar_component.rb` + `.html.erb` (new)
  - `app/components/viability_badge_component.rb` (new)
  - `app/components/page_header_component.rb` + `.html.erb` (new)
  - `app/controllers/seed_sources_controller.rb` (new)
  - `app/controllers/viability_audit_controller.rb` (new)
  - `app/javascript/controllers/nav_toggle_controller.js` (new)
  - `app/views/home/index.html.erb` (updated — uses PageHeaderComponent)
  - `app/views/layouts/application.html.erb` (updated — NavBarComponent, styling)
  - `app/views/seed_sources/index.html.erb` (new)
  - `app/views/viability_audit/index.html.erb` (new)
  - `config/routes.rb` (updated — seed_sources, viability_audit routes)
  - `spec/components/nav_bar_component_spec.rb` (new)
  - `spec/components/viability_badge_component_spec.rb` (new)
  - `spec/components/page_header_component_spec.rb` (new)
  - `spec/support/view_component.rb` (new)
- **Learnings for future iterations:**
  - ViewComponent `render_inline` requires capybara gem — must be in Gemfile test group
  - `spec/support/view_component.rb` configures `ViewComponent::TestHelpers` and `Capybara::RSpecMatchers` for `type: :component` specs
  - ViewComponent `Data.define` is a clean Ruby 3.2+ way to define simple value objects (used for NavItem)
  - `class_names` helper in ERB handles conditional Tailwind classes cleanly
  - Stimulus controllers auto-register when placed in `app/javascript/controllers/` — no manual registration needed
  - Fixed header with `fixed top-0 left-0 right-0 z-50` plus `pt-20` on main content for clearance
---

## 2026-02-16 - US-019
- Implemented inventory quick filters: viability status (Viable/Needs Testing/Expired), Heirloom toggle, Seed Source dropdown
- Added Plant model scopes: `.heirloom`, `.with_seed_source(id)`, `.with_viability_status(status)`
- Viability filter uses raw SQL subquery to avoid DISTINCT + ORDER BY conflicts with PostgreSQL
- Filters combine with each other (AND logic), with search, and with taxonomy navigation
- Active filters visually indicated with filled/highlighted button styles; clear all filters button when any filter active
- Search bar preserves filter params as hidden fields so filters persist across search input changes
- Created Stimulus `inventory-filters` controller for seed source dropdown Turbo Frame navigation
- Filters partial (`_filters.html.erb`) renders on both index and browse views
- Added 21 new specs: 10 model specs for new scopes, 11 request specs for filter behavior
- Files changed:
  - `app/models/plant.rb` (updated — added heirloom, with_seed_source, with_viability_status scopes)
  - `app/controllers/inventory_controller.rb` (updated — added load_filters, apply filters in load_plants)
  - `app/views/inventory/_filters.html.erb` (new — filter buttons and seed source dropdown)
  - `app/views/inventory/_search_bar.html.erb` (updated — hidden fields for filter params)
  - `app/views/inventory/index.html.erb` (updated — renders filters partial)
  - `app/views/inventory/browse.html.erb` (updated — renders filters partial)
  - `app/javascript/controllers/inventory_filters_controller.js` (new — Stimulus controller for source dropdown)
  - `spec/models/plant_spec.rb` (updated — added scope specs)
  - `spec/requests/inventory_spec.rb` (updated — added filter specs)
- **Learnings for future iterations:**
  - PostgreSQL `SELECT DISTINCT` requires ORDER BY columns to be in the SELECT list — use subqueries (`WHERE id IN (SELECT ...)`) instead of `.distinct` when ordering by joined table columns
  - Raw SQL subqueries with aliased tables (`sp`, `p`, `pc`) avoid conflicts when pg_search also joins the same tables
  - `request.query_parameters.except("key")` in views is useful for toggling filters while preserving other params
  - Filter state must be propagated in three ways: URL params (links), hidden fields (search form), and Stimulus (select dropdown)
  - Turbo Frame `src` assignment triggers frame navigation without a full page reload
---

## 2026-02-17 - US-023
- Implemented AI Viability Data Enrichment for PlantCategory records
- Added `expected_viability_years_ai_populated` boolean column to `plant_categories` table
- Created `ViabilityDataEnrichmentJob` background job that calls Anthropic Claude API to research seed viability years for a given plant category
- Added `research_viability` member action on `PlantCategoriesController`
- Added nested member route: `POST /plant_types/:plant_type_id/plant_categories/:id/research_viability`
- Updated plant categories index view with:
  - "Research" button (lightbulb icon, indigo color) for categories without viability data
  - "AI" badge (blue) on categories with AI-populated viability data
  - Turbo Stream subscriptions for real-time updates when AI job completes
- Created `_viability_cell.html.erb` partial for Turbo Stream broadcast replacements
- User can override AI-suggested values at any time via the existing edit form
- Added 16 job specs and 3 request specs (total 19 new tests, all passing)
- Files changed:
  - `db/migrate/20260217012830_add_expected_viability_years_ai_populated_to_plant_categories.rb` (new)
  - `app/jobs/viability_data_enrichment_job.rb` (new)
  - `app/controllers/plant_categories_controller.rb` (updated — added research_viability action)
  - `app/views/plant_categories/index.html.erb` (updated — research button, AI badge, Turbo Stream)
  - `app/views/plant_categories/_viability_cell.html.erb` (new — partial for viability cell)
  - `config/routes.rb` (updated — added research_viability member route)
  - `db/schema.rb` (auto-updated by migration)
  - `spec/jobs/viability_data_enrichment_job_spec.rb` (new)
  - `spec/requests/plant_categories_spec.rb` (updated — added 6 new specs)
- **Learnings for future iterations:**
  - AI job pattern is well-established: `call_anthropic` → `parse_response` → `save_*` → `broadcast_update`, with `api_key` helper
  - For nested resource actions (plant_categories nested under plant_types), use `member do ... end` inside the nested block
  - The `expected_viability_years_ai_populated` boolean follows the same pattern as `latin_name_ai_populated` and `latin_genus_ai_populated`
  - Turbo Stream broadcast targets must match the DOM element ID exactly for real-time updates
  - Rubocop can't parse ERB files — only lint `.rb` files
---

## 2026-02-17 - US-025
- Implemented Spreadsheet Import — File Upload and Parsing
- Added `roo` gem for .xlsx parsing, `csv` gem (Ruby 3.4 requirement), and `caxlsx` gem for test fixture generation
- Installed Active Storage for file uploads (migration for active_storage_tables)
- Created `SpreadsheetImport` model with: original_filename, status (enum: pending/parsing/parsed/failed), total_rows, parsed_rows, error_message, sheet_names (jsonb), Active Storage file attachment
- Created `SpreadsheetImportRow` model with: spreadsheet_import_id (FK), sheet_name, row_number, variety_name, seed_source_name, year_purchased, raw_date_value, germination_rate, raw_germination_value, notes, detected_used_up, has_gray_text, raw_data (jsonb), parse_warnings (jsonb)
- Created `SpreadsheetParseJob` background job that:
  - Opens xlsx via Roo, detects matching sheet tabs (Vegetables, Grains, Herbs, Flowers, Cover Crops)
  - Maps column headers to fields using regex pattern matching (handles inconsistent column names like "Variety"/"Name"/"Cultivar", "Source"/"Supplier"/"Purchased From")
  - Extracts variety name, seed source, year/date info, germination data, notes from each row
  - Handles various date formats: DateTime objects, plain integers, compound strings ("Jan 2023"), 4-digit year extraction
  - Converts germination rates: decimal (0.92), percentage integer (95→0.95), percentage string ("85%"→0.85)
  - Detects used-up rows from content patterns ("used up", "depleted", "gone", "empty", "finished")
  - Stores raw data as JSON and records parse warnings
  - Broadcasts Turbo Stream status updates during parsing
- Created `SpreadsheetImportsController` with new (upload form), create (file upload + job enqueue), show (results display)
- Created views: upload form with file validation, show page with status indicator + parsed rows table by sheet, status partial for Turbo Stream updates
- Added file-upload Stimulus controller for client-side .xlsx validation
- Added "Import" link to NavBarComponent navigation
- Added routes: `resources :spreadsheet_imports, only: [:new, :create, :show]`
- Created test xlsx fixture helper (`spec/support/xlsx_helper.rb`) using caxlsx for generating test spreadsheets
- 44 new specs: 10 model specs (SpreadsheetImport + SpreadsheetImportRow), 19 job specs (parsing, column mapping, date/germination extraction, used-up detection, error handling), 7 request specs, 8 factory/validation specs
- All 458 specs pass, rubocop clean
- Files changed:
  - `Gemfile` / `Gemfile.lock` (updated — added roo, csv, caxlsx)
  - `db/migrate/20260217014401_create_spreadsheet_imports.rb` (new)
  - `db/migrate/20260217014404_create_spreadsheet_import_rows.rb` (new)
  - `db/migrate/20260217014525_create_active_storage_tables.active_storage.rb` (new)
  - `app/models/spreadsheet_import.rb` (new)
  - `app/models/spreadsheet_import_row.rb` (new)
  - `app/jobs/spreadsheet_parse_job.rb` (new)
  - `app/controllers/spreadsheet_imports_controller.rb` (new)
  - `app/views/spreadsheet_imports/new.html.erb` (new)
  - `app/views/spreadsheet_imports/show.html.erb` (new)
  - `app/views/spreadsheet_imports/_status.html.erb` (new)
  - `app/javascript/controllers/file_upload_controller.js` (new)
  - `app/components/nav_bar_component.rb` (updated — added Import nav item)
  - `config/routes.rb` (updated — added spreadsheet_imports resource)
  - `db/schema.rb` (auto-updated)
  - `spec/models/spreadsheet_import_spec.rb` (new)
  - `spec/models/spreadsheet_import_row_spec.rb` (new)
  - `spec/jobs/spreadsheet_parse_job_spec.rb` (new)
  - `spec/requests/spreadsheet_imports_spec.rb` (new)
  - `spec/factories/spreadsheet_imports.rb` (new)
  - `spec/factories/spreadsheet_import_rows.rb` (new)
  - `spec/support/xlsx_helper.rb` (new)
- **Learnings for future iterations:**
  - Ruby 3.4 removed `csv` from default gems — must add explicitly to Gemfile when using `roo`
  - Column matcher ordering matters: use ordered array with `break` after first match per header to prevent ambiguous assignments (e.g., "Purchased From" vs "Date Purchased")
  - Roo doesn't expose cell formatting (font color) for xlsx — used-up detection falls back to content pattern matching ("used up", "gone", etc.)
  - `caxlsx` gem (Axlsx) is useful for generating test xlsx fixtures programmatically — use `Axlsx::Package` + `workbook.add_worksheet`
  - Active Storage needs explicit installation via `rails active_storage:install` + migration run
  - SpreadsheetImport uses `has_one_attached :file` with content type validation in model
  - JSONB columns are great for storing raw data and parse warnings — flexible schema for varying spreadsheet layouts
---

## 2026-02-17 - US-026
- Implemented Spreadsheet Import — AI-Assisted Mapping and Review
- Created `SpreadsheetMappingJob` that processes parsed rows in batches of 20 via Anthropic Claude API:
  - Sends existing taxonomy (PlantTypes > Categories > Subcategories) and seed sources as context
  - AI maps variety names to plant type + category + subcategory structure
  - AI normalizes seed source names (matches abbreviations, misspellings to existing sources)
  - AI extracts year_purchased from raw date values already parsed in US-025
  - Stores confidence scores and mapping notes per row
- Added mapping columns to `spreadsheet_import_rows`: mapped_plant_type_name, mapped_category_name, mapped_subcategory_name, mapped_source_name, mapping_status (enum), mapping_confidence, ai_mapping_data (jsonb), duplicate_of_row_id, mapping_notes
- Added `mapping` and `mapped` status values to SpreadsheetImport enum + `mapped_rows`/`mapped_percentage`
- Added `mapping_status` enum to SpreadsheetImportRow: unmapped, ai_mapped, accepted, modified, rejected
- Duplicate detection: after AI mapping, identifies rows with identical normalized variety names and flags later occurrences with `duplicate_of_row_id`
- Created review interface (`review.html.erb`) with:
  - Stats summary bar (total, AI mapped, accepted, modified, duplicates)
  - Table showing each row with original data, AI mapping, confidence score, and status badge
  - Accept/Edit/Reject action buttons per row
  - Inline edit form with plant type → category cascading dropdowns
  - Source name normalization display (shows "→ normalized name" when different)
  - Duplicate badge on flagged rows
  - Color-coded rows: green (accepted), blue (modified), amber (duplicate), red-dim (rejected)
- Created `create_taxonomy` action for creating new categories/subcategories during review
- Added "Start AI Mapping" button to parsed import show page, "Review Mappings" button to mapped imports
- Added Stimulus controllers: edit_mapping_controller (toggle edit form), mapping_select_controller (cascade plant type → category), modal_controller (taxonomy creation modal)
- 33 new specs: 10 job specs (mapping, duplicates, error handling, skip already-mapped), 12 model specs (enums, scopes, duplicate?, mapping_complete?), 11 request specs (review page, accept/modify/reject, taxonomy creation, mapping button states)
- All 491 specs pass, rubocop clean
- Files changed:
  - `db/migrate/20260217015407_add_mapping_fields_to_spreadsheet_import_rows.rb` (new)
  - `db/migrate/20260217015419_add_mapping_status_to_spreadsheet_imports.rb` (new)
  - `app/models/spreadsheet_import.rb` (updated — mapping/mapped status, mapped_percentage)
  - `app/models/spreadsheet_import_row.rb` (updated — mapping_status enum, scopes, duplicate?, mapping_complete?)
  - `app/jobs/spreadsheet_mapping_job.rb` (new — AI batch mapping + duplicate detection)
  - `app/controllers/spreadsheet_imports_controller.rb` (updated — review, start_mapping, update_row_mapping, create_taxonomy)
  - `app/views/spreadsheet_imports/review.html.erb` (new)
  - `app/views/spreadsheet_imports/_review_row.html.erb` (new)
  - `app/views/spreadsheet_imports/_taxonomy_options.html.erb` (new)
  - `app/views/spreadsheet_imports/_status.html.erb` (updated — mapping/mapped states, action buttons)
  - `app/helpers/spreadsheet_imports_helper.rb` (new — row_classes helper)
  - `app/javascript/controllers/edit_mapping_controller.js` (new)
  - `app/javascript/controllers/mapping_select_controller.js` (new)
  - `app/javascript/controllers/modal_controller.js` (new)
  - `config/routes.rb` (updated — start_mapping, review, update_row_mapping, create_taxonomy member routes)
  - `db/schema.rb` (auto-updated)
  - `spec/jobs/spreadsheet_mapping_job_spec.rb` (new)
  - `spec/models/spreadsheet_import_row_spec.rb` (updated)
  - `spec/models/spreadsheet_import_spec.rb` (updated)
  - `spec/requests/spreadsheet_imports_spec.rb` (updated)
  - `spec/factories/spreadsheet_import_rows.rb` (updated — ai_mapped/accepted/modified/rejected traits)
  - `spec/factories/spreadsheet_imports.rb` (updated — mapping/mapped traits)
- **Learnings for future iterations:**
  - AI batch processing pattern: load existing taxonomy/sources as context, send rows in batches of 20, parse JSON array response mapping to rows by index
  - Duplicate detection by normalized variety name (lowercase, stripped, whitespace-collapsed) is a simple and effective heuristic
  - `in_batches(of: N)` with ActiveRecord returns relation batches — call `.to_a` to get actual records for enumeration
  - SpreadsheetImport status enum extended to 6 values: pending → parsing → parsed → mapping → mapped, with failed as error state from any step
  - Review interface uses Turbo Stream replace on individual row `<tr>` elements for accept/modify/reject without full page reload
  - Cascading dropdowns in inline forms: use `data-plant-type` attributes on options + hide/show via Stimulus instead of fetching from server
---

## 2026-02-17 - US-027
- Implemented Spreadsheet Import — Confirm and Execute
- Added migration for `executed_rows` (integer, default 0) and `import_report` (jsonb, default {}) to `spreadsheet_imports`
- Extended SpreadsheetImport status enum with `executing: 6` and `executed: 7`
- Added `importable_rows` scope (accepted + modified, excluding duplicates) and `import_summary` method to SpreadsheetImport
- Created `SpreadsheetExecuteJob` that:
  - Processes importable rows in a single database transaction (rollback on failure)
  - Creates SeedSource records, deduplicating by case-insensitive name match
  - Creates PlantCategory and PlantSubcategory records as needed
  - Consolidates duplicate variety rows into single Plant with multiple SeedPurchase records
  - Sets `used_up: true` and `used_up_at` on rows detected as used up
  - Falls back to "Unknown" source when no source is mapped
  - Falls back to current year when `year_purchased` is nil
  - Defaults new plants to `life_cycle: :annual`
  - Tracks progress via `executed_rows` and broadcasts Turbo Stream updates every 5 rows
  - Stores detailed import report: plants_created, purchases_created, sources_created, categories_created, subcategories_created, rows_skipped, errors
- Added `confirm` action: shows summary counts (plants, purchases, sources, categories) and table of rows to import by sheet
- Added `execute` action: enqueues SpreadsheetExecuteJob and redirects to show page
- Updated `_status.html.erb` partial with executing/executed states, progress bar, and import summary report display
- Added "Confirm & Import" button to mapped imports status bar
- Added routes: `get :confirm`, `post :execute` on spreadsheet_imports member
- 27 new specs: 19 job specs (creation, deduplication, consolidation, used_up, transaction rollback, germination, nil-year), 8 request specs (confirm page, summary counts, excluded rows, execute enqueue, redirects, executed report)
- Updated existing enum spec to include new status values
- All 518 specs pass, rubocop clean
- Files changed:
  - `db/migrate/20260217020243_add_execution_fields_to_spreadsheet_imports.rb` (new)
  - `app/models/spreadsheet_import.rb` (updated — executing/executed enum, importable_rows, import_summary)
  - `app/jobs/spreadsheet_execute_job.rb` (new)
  - `app/controllers/spreadsheet_imports_controller.rb` (updated — confirm, execute actions)
  - `app/views/spreadsheet_imports/confirm.html.erb` (new)
  - `app/views/spreadsheet_imports/_status.html.erb` (updated — executing/executed states, report)
  - `config/routes.rb` (updated — confirm, execute member routes)
  - `db/schema.rb` (auto-updated)
  - `spec/jobs/spreadsheet_execute_job_spec.rb` (new)
  - `spec/requests/spreadsheet_imports_spec.rb` (updated — 8 new specs)
  - `spec/models/spreadsheet_import_spec.rb` (updated — enum values)
  - `spec/factories/spreadsheet_imports.rb` (updated — executing, executed traits)
- **Learnings for future iterations:**
  - SpreadsheetImport status enum now has 8 values: pending → parsing → parsed → mapping → mapped → executing → executed, with failed from any step
  - Transaction wrapping is critical for import jobs — `ActiveRecord::Base.transaction do` ensures all-or-nothing
  - Case-insensitive dedup for seed sources: `SeedSource.find_by("LOWER(name) = ?", name.downcase)`
  - Plant consolidation: find existing by category + lowercase name, create if not found, add purchase either way
  - `import_report` is stored as JSONB — keys become strings when serialized/deserialized (use `report["key"]` not `report[:key]` in views)
  - Turbo confirm dialogs: `data: { turbo_confirm: "message" }` on link_to with turbo_method
---

## 2026-02-16 - US-028
- Implemented Seed Source Merge feature
- Added `merge_with!` method on SeedSource model that:
  - Accepts a single source or array of sources to merge
  - Reassigns all seed purchases from merged sources to the primary
  - Deletes merged (duplicate) source records
  - Wraps everything in a transaction for atomicity
  - Raises ArgumentError if trying to merge a source with itself
- Added merge routes: `GET /seed_sources/merge` (confirmation page) and `POST /seed_sources/execute_merge`
- Updated seed sources index with:
  - Checkboxes for multi-select with "select all" header checkbox
  - Merge toolbar (appears when 2+ sources selected) with selection count and "Merge Selected" button
  - Stimulus `merge-select` controller for checkbox state management and validation
- Created merge confirmation view (`merge.html.erb`):
  - Radio buttons to select primary source to keep
  - Table showing each source with name, URL, total purchases, active purchases, notes
  - Confirmation dialog before executing merge
  - Cancel link back to seed sources index
- 14 new specs: 7 model specs (merge_with! for reassignment, deletion, preservation, empty source, single source, self-merge, transaction), 7 request specs (merge page, redirect guards, purchase counts, execute merge, multi-source merge)
- All 532 specs pass, rubocop clean
- Files changed:
  - `app/models/seed_source.rb` (updated — added merge_with! method)
  - `app/controllers/seed_sources_controller.rb` (updated — added merge, execute_merge actions)
  - `app/views/seed_sources/index.html.erb` (updated — checkboxes, merge toolbar, Stimulus controller)
  - `app/views/seed_sources/merge.html.erb` (new — merge confirmation page)
  - `app/javascript/controllers/merge_select_controller.js` (new — Stimulus controller for checkbox selection)
  - `config/routes.rb` (updated — added merge, execute_merge collection routes)
  - `spec/models/seed_source_spec.rb` (updated — 7 new merge specs)
  - `spec/requests/seed_sources_spec.rb` (updated — 7 new merge request specs)
- **Learnings for future iterations:**
  - `update_all` on association bypasses callbacks and validations — good for bulk reassignment where we just need to change the FK
  - `dependent: :restrict_with_error` on has_many prevents deletion when there are associated records, but `destroy!` works after reassignment since purchases are moved first
  - Stimulus controller targets with `data-merge-select-target` work well for managing multi-select checkbox state and toolbar visibility
  - Form with `form_tag` + `method: :get` is a clean pattern for sending checkbox selections as query params to a confirmation page
  - HTML entity escaping in response bodies (e.g., `&#39;` for `'`) means tests should avoid apostrophes in names or use CGI.escapeHTML
---

## 2026-02-16 - US-029
- Implemented Bulk Mark-as-Used for Seed Audit
- Viability audit view already had multi-select checkboxes and bulk mark-as-used action (from US-024)
- Added multi-select checkboxes to inventory browser `_plant_list.html.erb` partial:
  - Reuses existing `bulk-select` Stimulus controller for checkbox state management
  - Toolbar with selection count and "Mark Selected as Used Up" button appears when plants are selected
  - Confirmation dialog via `data-turbo-confirm` before executing bulk action
  - Checkboxes only appear for plants with active (non-used-up) purchases
  - Hidden form submits plant_ids[] array to bulk action endpoint
- Added `bulk_mark_used_up` action to `InventoryController`:
  - Accepts `plant_ids[]` param and marks all active purchases for selected plants as used up
  - Uses `SeedPurchase.where(plant_id: ids, used_up: false).update_all(...)` for single-operation update
  - Redirects with count notice showing number of purchases marked
- Added `PATCH /inventory/bulk_mark_used_up` route
- 11 new specs: 5 UI specs (bulk-select on index/browse, checkbox presence/absence, button), 6 action specs (mark purchases, unselected plants unaffected, already-used-up ignored, multi-plant, count notice, no-selection alert)
- All 543 specs pass, rubocop clean
- Files changed:
  - `app/controllers/inventory_controller.rb` (updated — added bulk_mark_used_up action)
  - `app/views/inventory/_plant_list.html.erb` (updated — added bulk-select controller, checkboxes, toolbar, form)
  - `config/routes.rb` (updated — added bulk_mark_used_up_inventory route)
  - `spec/requests/inventory_spec.rb` (updated — 11 new specs)
- **Learnings for future iterations:**
  - The bulk-select Stimulus controller is generic and reusable across viability audit, seed purchases, and inventory views
  - Inventory browser operates on plants (not individual purchases), so bulk action takes `plant_ids[]` and marks all active purchases for those plants
  - `update_all` with `used_up: false` condition naturally skips already-used-up purchases, preventing redundant updates
  - Column count in empty-state `colspan` must be updated when adding checkbox column (3→4 or 4→5)
---

## 2026-02-16 - US-030
- Implemented system/integration tests for all five core user workflows
- Created `spec/requests/workflows/` directory for workflow integration tests
- 76 new tests covering:
  1. **Browse taxonomy hierarchy and view plant detail** (12 specs): Inventory home, browse by type/category/subcategory, breadcrumb navigation, plant detail page with metadata/purchases/viability badges/actions
  2. **Create a new plant with category and add a seed purchase** (12 specs): New plant form, create with required/optional fields, validation rejection, add purchase to plant, end-to-end workflow
  3. **Search for a plant and filter by viability status** (14 specs): Full-text search by name/partial/empty, viability filters (viable/test/expired), heirloom filter, seed source filter, combined filters, filter state indicators
  4. **Mark a purchase as used up and verify inventory updates** (11 specs): Single mark used up, mark active again, inventory/audit reflects changes, mark from audit view, bulk mark from inventory/audit
  5. **Viability audit dashboard with correct status badges** (27 specs): Summary counts, status badges (viable/test/expired), color-coded rows, sorting, filtering (viability/type/category/source/year), audit actions, empty states
- All 619 tests pass (543 existing + 76 new), rubocop clean
- Files changed:
  - `spec/requests/workflows/browse_taxonomy_and_view_plant_spec.rb` (new)
  - `spec/requests/workflows/create_plant_and_purchase_spec.rb` (new)
  - `spec/requests/workflows/search_and_filter_spec.rb` (new)
  - `spec/requests/workflows/mark_purchase_used_up_spec.rb` (new)
  - `spec/requests/workflows/viability_audit_dashboard_spec.rb` (new)
- **Learnings for future iterations:**
  - Request specs (type: :request) are the best approach for CI-compatible integration tests — no browser/Selenium required
  - Turbo Frame-targeted links don't work with rack_test driver, so test navigation by visiting URLs directly with params
  - Viability status depends on current year — use `Date.current.year - N` for deterministic year-based test data
  - `follow_redirect!` in request specs is essential for testing flash messages after redirects
  - Use `response.body.index("text")` comparisons to verify element ordering in sorted views
  - The `not_to include("Roma</a>")` pattern helps avoid false positives when a name appears in different contexts (e.g., in nav vs content)
---
