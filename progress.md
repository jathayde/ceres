## Codebase Patterns
- Use `find_or_create_by!` in seeds for idempotent seed data
- Models use `default_scope { order(:position) }` for position-ordered records
- Factory sequences for unique fields: `sequence(:name) { |n| "Plant Type #{n}" }`
- Database constraints (null: false, unique index) should mirror model validations
- Use `dependent: :restrict_with_error` on associations where deletion should be prevented when children exist
- Add `deletable?` method to models that need deletion protection checks
- Turbo Frames use `turbo_frame_tag model_instance` for inline editing patterns
- Request specs go in `spec/requests/` and use `type: :request`
- Flash messages (notice/alert) rendered in application layout
- Non-nested CRUD controllers follow same pattern as PlantTypesController (before_action, set_*, params permit, deletable? guard)
- `default_scope { order(:name) }` for alphabetically-sorted resources (vs `:position` for manually ordered ones)
- `active_purchases_count` method on SeedSource for counting non-used-up purchases
- Cascading dropdowns via Stimulus controller + JSON endpoints (e.g., `categories_for_type`, `subcategories_for_category`)
- Plant form uses `plant_type_id` as a virtual selector (not persisted on Plant), driving category/subcategory cascades
- Use `hidden_field_tag` with empty value for array params (like `planting_seasons[]`) so empty arrays submit correctly
- Inline creation pattern: Stimulus controller + JSON POST endpoint (e.g., `inline_source_controller.js` + `seed_sources/inline_create`)
- Display fields for user-friendly input (dollars, percentage) synced to hidden fields for actual model values (cents, decimal 0-1) via Stimulus
- Bulk actions: use HTML `form` attribute on checkboxes to link them to a hidden `form_with`, with Stimulus controller for select-all/toolbar visibility
- ViewComponents: TaxonomySidebarComponent for hierarchical navigation, InventoryBreadcrumbComponent for breadcrumbs
- Turbo Frame `inventory_content` wraps the main content area; sidebar links use `data-turbo-frame` to target it
- Collapsible tree pattern: `taxonomy_tree_controller.js` Stimulus controller with `expanded` value and `children` target
- Plant model has `active_purchases`, `best_viability_status` methods for inventory display
- pg_search: `include PgSearch::Model` + `pg_search_scope` on model, use `associated_against` for searching through associations
- Search integrates into existing `load_plants` by conditionally applying `.search(query)` before other filters
- Debounced search form: Stimulus `search_form_controller` with `requestSubmit()` + Turbo Frame targeting
- Plant detail page: `plants#show` with back_to param for preserving inventory browser state
- Plant names in inventory list link to detail page with `data-turbo-frame: "_top"` to break out of Turbo Frame
- When adding `show` to a resource that had `except: :show`, custom GET routes like `plants/categories_for_type` must use `collection` block (not standalone routes) to avoid being matched by `:id` param
- AI background jobs: `GrowingGuideResearchJob` pattern — call API, parse JSON, save to model, broadcast Turbo Stream update
- Anthropic SDK: `Anthropic::Client.new(api_key:)` → `client.messages.create(model:, max_tokens:, messages:)` → `response.content.first.text`
- Use `local_assigns.fetch(:key, default)` for optional partial locals; `turbo_stream_from` for Turbo Stream subscriptions
---

## 2026-02-16 - US-002
- Implemented PlantType model with name (string, unique, not null), description (text), position (integer), timestamps
- Migration includes unique index on name column
- Model has presence/uniqueness validations and default_scope ordering by position
- Seed data: Vegetable, Grain, Herb, Flower, Cover Crop (idempotent via find_or_create_by!)
- Factory uses sequences for unique name generation
- 5 passing specs covering validations, ordering, and factory behavior
- Files changed:
  - db/migrate/20260216233522_create_plant_types.rb
  - app/models/plant_type.rb
  - db/seeds.rb
  - spec/models/plant_type_spec.rb
  - spec/factories/plant_types.rb
- **Learnings for future iterations:**
  - Rails 8.1.2 project with RSpec, FactoryBot, Shoulda Matchers, Faker all pre-configured
  - spec/support/shoulda_matchers.rb already set up
  - FactoryBot syntax methods already included in rails_helper.rb
  - Use `bin/rails generate model` to scaffold model, migration, spec, and factory together
---

## 2026-02-16 - US-012
- Implemented full CRUD for PlantType, PlantCategory (nested under PlantType), and PlantSubcategory (nested under PlantCategory)
- Changed `dependent: :destroy` to `dependent: :restrict_with_error` on all three models to prevent deletion when children exist
- Added `deletable?` method to all three models for checking deletion safety
- Added `has_many :plants, through: :plant_categories` to PlantType for transitive access
- Created nested routes: `plant_types > plant_categories > plant_subcategories`
- Turbo Frames wrap table rows and edit forms for inline editing without full page reloads
- Breadcrumb navigation on all nested views
- Position field for sort order on all forms
- PlantCategory form includes latin_genus, latin_species, expected_viability_years
- Flash messages (notice/alert) added to application layout
- 141 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - config/routes.rb (added nested routes)
  - app/models/plant_type.rb (restrict_with_error, deletable?, through association)
  - app/models/plant_category.rb (restrict_with_error, deletable?)
  - app/models/plant_subcategory.rb (restrict_with_error, deletable?)
  - app/controllers/plant_types_controller.rb (new)
  - app/controllers/plant_categories_controller.rb (new)
  - app/controllers/plant_subcategories_controller.rb (new)
  - app/views/plant_types/ (index, new, edit, _form)
  - app/views/plant_categories/ (index, new, edit, _form)
  - app/views/plant_subcategories/ (index, new, edit, _form)
  - app/views/layouts/application.html.erb (flash messages)
  - spec/models/plant_type_spec.rb (updated associations, added deletable? tests)
  - spec/models/plant_category_spec.rb (updated associations, added deletable? tests)
  - spec/models/plant_subcategory_spec.rb (updated associations, added deletable? tests)
  - spec/requests/plant_types_spec.rb (new)
  - spec/requests/plant_categories_spec.rb (new)
  - spec/requests/plant_subcategories_spec.rb (new)
- **Learnings for future iterations:**
  - Nested routes create long helper method names like `plant_type_plant_category_plant_subcategories_path`
  - `dependent: :restrict_with_error` adds errors to the model instead of raising an exception, works well with `deletable?` guard
  - Use `turbo_frame_tag model_instance` (passing the model directly) for automatic DOM IDs
  - `button_to` with `method: :delete` needs `form: { data: { turbo_confirm: "..." } }` for confirmation dialogs
  - Rack deprecation: `:unprocessable_entity` is deprecated in favor of `:unprocessable_content` in newer Rack versions
---

## 2026-02-16 - US-013
- Implemented full CRUD for Seed Sources (list, create, edit, delete)
- Updated SeedSource model: changed `dependent: :destroy` to `dependent: :restrict_with_error`, added `deletable?` method, added `active_purchases_count` method, added `default_scope { order(:name) }` for alphabetical sorting
- Expanded routes from `only: [:index]` to `except: :show` for full CRUD
- Created SeedSourcesController with all CRUD actions following existing pattern
- Created views: index (table with name, website link, active purchases count, notes, actions), _form (name required, URL, notes), new, edit (with turbo_frame_tag)
- Index shows clickable link to supplier website (opens in new tab)
- Delete only available when `deletable?` (no associated purchases), with confirmation dialog
- 160 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - app/models/seed_source.rb (restrict_with_error, deletable?, active_purchases_count, default_scope)
  - app/controllers/seed_sources_controller.rb (full CRUD)
  - app/views/seed_sources/index.html.erb (updated with full table)
  - app/views/seed_sources/_form.html.erb (new)
  - app/views/seed_sources/new.html.erb (new)
  - app/views/seed_sources/edit.html.erb (new)
  - config/routes.rb (expanded seed_sources routes)
  - spec/models/seed_source_spec.rb (updated associations, added deletable?, active_purchases_count, default scope tests)
  - spec/requests/seed_sources_spec.rb (new - full CRUD request specs)
- **Learnings for future iterations:**
  - Existing stub controller/views may already exist from US-011 layout work - check before creating from scratch
  - `includes(:seed_purchases)` on index to avoid N+1 queries for active_purchases_count
  - SeedSource uses `order(:name)` default scope unlike taxonomy models which use `order(:position)`
---

## 2026-02-16 - US-014
- Implemented full CRUD for Plant (Variety) management
- Updated Plant model: changed `dependent: :destroy` to `dependent: :restrict_with_error` for seed_purchases, added `deletable?` method, added `PLANTING_SEASON_OPTIONS` constant
- Created PlantsController with all CRUD actions plus `categories_for_type` and `subcategories_for_category` JSON endpoints for cascading dropdowns
- Created views: index (table with name, latin name, category, life cycle, heirloom badge, purchase count, actions), _form (cascading type > category > subcategory dropdowns, all plant fields including planting seasons checkboxes), new, edit
- Created Stimulus `cascading_select_controller.js` for dynamic form updates on type/category change
- Plant type selector drives category dropdown; category selector drives subcategory dropdown
- Subcategory wrapper hidden when category has no subcategories
- Form includes: heirloom checkbox, days to harvest range, winter hardiness, planting seasons multi-select, expected viability years override, notes
- Delete only available when `deletable?` (no associated seed purchases), with confirmation dialog
- 185 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - app/models/plant.rb (restrict_with_error, deletable?, PLANTING_SEASON_OPTIONS)
  - app/controllers/plants_controller.rb (new - full CRUD + JSON endpoints)
  - app/views/plants/index.html.erb (new)
  - app/views/plants/_form.html.erb (new - cascading dropdowns)
  - app/views/plants/new.html.erb (new)
  - app/views/plants/edit.html.erb (new)
  - app/javascript/controllers/cascading_select_controller.js (new - Stimulus controller)
  - config/routes.rb (added plants routes + cascading dropdown endpoints)
  - spec/models/plant_spec.rb (updated dependent association, added deletable? tests)
  - spec/requests/plants_spec.rb (new - full CRUD + JSON endpoint request specs)
- **Learnings for future iterations:**
  - Cascading dropdowns use Stimulus controller with JSON endpoints rather than Turbo Frames for simpler implementation
  - Plant type is a virtual selector (not a Plant attribute) used only to drive category filtering
  - `load_form_options` method in controller pre-populates dropdown data for edit forms based on existing associations
  - Array fields like `planting_seasons` need a hidden field with empty value to ensure empty arrays submit correctly
  - Use `references(:plant_category)` with `order("plant_categories.name")` when ordering by an association's column in `includes`
---

## 2026-02-16 - US-015
- Implemented full CRUD for Seed Purchases (list, create, edit, delete) as a standalone resource
- Created SeedPurchasesController with all CRUD actions plus `plants_search` JSON endpoint for plant typeahead
- Created views: index (table with plant, source, year, viability badge, quantity, cost, actions), _form (plant select, seed source select with inline create, purchase details, quantity & cost), new, edit
- Created Stimulus `inline_source_controller.js` for:
  - Inline seed source creation (toggleable form, AJAX POST to `/seed_sources/inline_create`, auto-adds new option to select)
  - Germination rate display (user enters percentage, hidden field stores decimal 0-1)
  - Cost display (user enters dollars, hidden field stores cents)
- Added `inline_create` action to SeedSourcesController returning JSON
- Added routes: `resources :seed_purchases`, `seed_purchases/plants_search`, `seed_sources/inline_create`
- Viability badge displayed on each purchase record using existing ViabilityBadgeComponent
- Used-up purchases shown with dimmed opacity
- 210 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - config/routes.rb (added seed_purchases routes + JSON endpoints)
  - app/controllers/seed_purchases_controller.rb (new - full CRUD + plants_search)
  - app/controllers/seed_sources_controller.rb (added inline_create action)
  - app/views/seed_purchases/index.html.erb (new)
  - app/views/seed_purchases/_form.html.erb (new - with inline source creation)
  - app/views/seed_purchases/new.html.erb (new)
  - app/views/seed_purchases/edit.html.erb (new)
  - app/javascript/controllers/inline_source_controller.js (new - inline source + field conversion)
  - spec/requests/seed_purchases_spec.rb (new - 25 specs covering CRUD + plants_search)
  - spec/requests/seed_sources_spec.rb (added 3 specs for inline_create)
- **Learnings for future iterations:**
  - Cost stored as cents (integer) and germination_rate as decimal 0-1 - use display fields for user-friendly input
  - Inline creation pattern: Stimulus controller handles AJAX form, adds new option to existing select element
  - SeedPurchase doesn't need `deletable?` guard - purchases can always be deleted
  - `plants_search` endpoint supports typeahead by searching with ILIKE
  - `plant_id` param on new action enables pre-selecting a plant (for linking from plant detail page)
---

## 2026-02-16 - US-016
- Implemented "Mark as Used Up" / "Mark as Active" toggle on each seed purchase
- Added bulk "Mark as Used Up" action with checkbox selection and Stimulus controller
- Used-up purchases are visually dimmed (opacity-50) and show "Used Up" viability badge
- Added member routes `mark_as_used_up` and `mark_as_active` (PATCH), collection route `bulk_mark_used_up` (PATCH)
- Bulk action uses HTML `form` attribute on checkboxes to associate with a hidden form, avoiding nested form issues
- 221 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - config/routes.rb (added member/collection routes for mark_as_used_up, mark_as_active, bulk_mark_used_up)
  - app/controllers/seed_purchases_controller.rb (added mark_as_used_up, mark_as_active, bulk_mark_used_up actions)
  - app/views/seed_purchases/index.html.erb (added toggle buttons, bulk checkboxes, select-all, bulk toolbar)
  - app/javascript/controllers/bulk_select_controller.js (new - Stimulus controller for checkbox selection + toolbar visibility)
  - spec/requests/seed_purchases_spec.rb (added 11 specs for mark_as_used_up, mark_as_active, bulk_mark_used_up, index display)
- **Learnings for future iterations:**
  - Use HTML `form` attribute on checkboxes to associate them with a remote form element, avoiding nested `<form>` issues with `button_to`
  - `update_all` returns the count of updated rows, useful for building flash messages
  - Stimulus `indeterminate` property on checkbox for partial selection state
  - Bulk actions need CSRF protection which `form_with` handles automatically
---

## 2026-02-16 - US-017
- Implemented Inventory Browser with hierarchical sidebar navigation
- Created InventoryController with `index` (all plants) and `browse` (filtered by type/category/subcategory) actions
- Created TaxonomySidebarComponent: collapsible tree showing PlantType > PlantCategory > PlantSubcategory hierarchy
- Created InventoryBreadcrumbComponent: breadcrumb trail showing current position in hierarchy
- Created taxonomy_tree_controller.js Stimulus controller for expand/collapse tree nodes
- Plant list shows: variety name, latin name, heirloom badge, best viability status, active purchase count
- Turbo Frames used for content area so sidebar navigation doesn't cause full page reloads
- Added `active_purchases` and `best_viability_status` methods to Plant model
- Updated NavBarComponent to highlight Inventory for browse paths
- Root path now points to inventory#index (replaces home#index)
- 248 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - config/routes.rb (added inventory_browse route, changed root to inventory#index)
  - app/controllers/inventory_controller.rb (new - index + browse actions)
  - app/models/plant.rb (added active_purchases, best_viability_status methods)
  - app/components/taxonomy_sidebar_component.rb (new)
  - app/components/taxonomy_sidebar_component.html.erb (new)
  - app/components/inventory_breadcrumb_component.rb (new)
  - app/components/inventory_breadcrumb_component.html.erb (new)
  - app/components/nav_bar_component.rb (updated active state for browse path)
  - app/views/inventory/index.html.erb (new - main inventory page with sidebar + plant list)
  - app/views/inventory/browse.html.erb (new - filtered view with breadcrumbs)
  - app/views/inventory/_plant_list.html.erb (new - shared plant list partial)
  - app/javascript/controllers/taxonomy_tree_controller.js (new - collapsible tree Stimulus controller)
  - spec/requests/inventory_spec.rb (new - 22 specs covering index, browse by type/category/subcategory, plant list content)
  - spec/models/plant_spec.rb (added 7 specs for active_purchases, best_viability_status)
- **Learnings for future iterations:**
  - Turbo Frames with named IDs (e.g., `inventory_content`) let sidebar links target the content area without full page reloads using `data-turbo-frame` attribute
  - `load_browse_context` pattern: check params from most specific (subcategory) to least specific (type) so parent context is always derived
  - ViewComponents are ideal for reusable navigation elements (sidebar, breadcrumbs) - encapsulate rendering logic and selection state
  - `Plant.includes(seed_purchases: :seed_source)` needed to avoid N+1 when computing viability on the plant list
  - Inventory browser uses a standalone route (`inventory/browse`) rather than nested resources to keep URL params simple
---

## 2026-02-16 - US-018
- Implemented full-text search across plant name, latin name, notes, and seed source name using pg_search gem
- Added `PgSearch::Model` to Plant model with `pg_search_scope :search` using tsearch with prefix matching and English dictionary
- Added `has_many :seed_sources, through: :seed_purchases` to enable searching through seed source names
- Search integrates into existing InventoryController `load_plants` method - applied before taxonomy filters
- Created `_search_bar.html.erb` partial with search icon, clear button, and debounced input
- Created `search_form_controller.js` Stimulus controller for debounced search (300ms delay) with `requestSubmit()` for Turbo Frame integration
- Search bar appears on both index and browse pages, preserving browse context via hidden fields
- Results show search heading with query text and result count
- Empty search shows all plants; search works via Turbo Frame without full page reloads
- 271 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - app/models/plant.rb (added PgSearch::Model, pg_search_scope, has_many :seed_sources through)
  - app/controllers/inventory_controller.rb (added @search_query, conditional search in load_plants)
  - app/views/inventory/index.html.erb (added search bar partial render, conditional heading)
  - app/views/inventory/browse.html.erb (added search bar partial render with browse context, conditional heading)
  - app/views/inventory/_search_bar.html.erb (new - search form partial with Stimulus controller)
  - app/javascript/controllers/search_form_controller.js (new - debounced search Stimulus controller)
  - spec/models/plant_spec.rb (added 7 specs for .search scope + has_many :seed_sources association)
  - spec/requests/inventory_spec.rb (added 16 specs for search functionality)
- **Learnings for future iterations:**
  - pg_search's `associated_against` only goes one level deep; use `has_many :through` to bridge deeper associations
  - pg_search `search` scope with `prefix: true` handles partial word matching naturally
  - When pg_search is active, it applies its own ordering (by rank); skip the default `order()` to preserve relevance ranking
  - Search form with GET method replaces query string; use hidden fields for browse context params (plant_type_id etc.)
  - `form_with data: { turbo_frame: "inventory_content" }` targets the Turbo Frame for instant results
---

## 2026-02-16 - US-020
- Implemented comprehensive plant detail view (show page)
- Added `show` action to PlantsController with eager-loaded seed purchases and growing guide
- Added `show` route to plants resource (previously had `except: :show`)
- Moved cascading dropdown JSON endpoints into `collection` block in routes to avoid `:id` param conflicts
- Updated route helper names in `_form.html.erb` and specs to match new collection route convention
- Plant metadata section: name, latin name, heirloom badge, life cycle, winter hardiness, days to harvest range, planting seasons, expected viability, notes
- Growing guide section: all GrowingGuide fields displayed when populated, placeholder with AI research suggestion when absent
- Seed purchases table: sorted by year descending, viability badge, source name (linked to URL), year, lot, quantity, cost, used-up status with toggle actions
- Quick actions: "Add Purchase" button (links to new seed purchase with plant pre-selected), "Edit Plant" link
- Back navigation: preserves inventory browser state via `back_to` param; plant list links pass `request.fullpath`
- Plant names in inventory browser now link to detail page using `data-turbo-frame: "_top"` to break out of Turbo Frame
- 309 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - config/routes.rb (changed `except: :show` to full resource, moved JSON endpoints to collection block)
  - app/controllers/plants_controller.rb (added show action, updated before_action)
  - app/views/plants/show.html.erb (new - comprehensive detail page)
  - app/views/inventory/_plant_list.html.erb (plant names now link to detail page)
  - app/views/plants/_form.html.erb (updated route helper names)
  - spec/requests/plants_spec.rb (added 18 show specs, updated route helper names)
- **Learnings for future iterations:**
  - When enabling `:show` on a resource, any standalone GET routes at `resource/path` will be matched as `resource/:id` — move them into `collection` block
  - Collection routes change helper names: `plants_categories_for_type_path` → `categories_for_type_plants_path`
  - Use `data-turbo-frame: "_top"` on links inside Turbo Frames to navigate to a full page (break out of the frame)
  - `back_to` param pattern: pass `request.fullpath` to preserve filters, search, and browse context for back navigation
---

## 2026-02-16 - US-021
- Implemented AI Growing Guide Research feature with Anthropic Claude API integration
- Created `GrowingGuideResearchJob` background job (Solid Queue) that:
  - Calls Anthropic Claude API (Sonnet 4.5) with structured prompt including plant name, latin name, and category context
  - Parses JSON response into GrowingGuide schema fields with safe enum handling
  - Creates/updates GrowingGuide record with `ai_generated: true` and timestamp
  - Broadcasts Turbo Stream update to replace the growing guide section on the plant detail page
  - Strips markdown code fences from AI responses
  - Handles invalid enum values gracefully (sets to nil)
- Added `research_growing_guide` member route and controller action on PlantsController
- Extracted growing guide section into `_growing_guide.html.erb` partial (used by both show page and Turbo Stream broadcast)
- Added "Research Growing Guide" / "Re-Research" button to plant detail page
- Added Turbo Stream subscription (`turbo_stream_from`) on plant show page for live updates
- API key configured via `ANTHROPIC_API_KEY` env var or Rails credentials
- 329 total specs pass, 0 failures; RuboCop clean
- Files changed:
  - app/jobs/growing_guide_research_job.rb (new - background job with AI integration)
  - app/controllers/plants_controller.rb (added research_growing_guide action)
  - app/views/plants/_growing_guide.html.erb (new - extracted growing guide partial)
  - app/views/plants/show.html.erb (replaced inline growing guide with partial + Turbo Stream subscription)
  - config/routes.rb (added member route for research_growing_guide)
  - spec/jobs/growing_guide_research_job_spec.rb (new - 13 specs covering AI call, parsing, saving, broadcasting, edge cases)
  - spec/requests/plants_spec.rb (added 7 specs for research action and growing guide UI)
- **Learnings for future iterations:**
  - Anthropic Ruby SDK v1.19: `Anthropic::Client.new(api_key:)`, `client.messages.create(model:, max_tokens:, messages:)`, response has `.content[0].text`
  - Response content blocks use `Anthropic::Models::TextBlock` (has `.text`), not `ContentBlock` (which is a module)
  - `button_to` with block: first arg is URL, not name — `button_to(url, options) { content }`
  - Use `local_assigns.fetch(:key, default)` in partials for optional locals (more reliable than `defined?`)
  - Turbo Stream subscription signs the stream name, so raw stream name won't appear in HTML — test for `turbo-cable-stream-source` element instead
  - `GrowingGuide.water_needs` (class method) returns the enum mapping hash — same name as instance method, works fine
  - `broadcast_replace_to` from jobs renders partial with URL helpers available via ApplicationController context
---
